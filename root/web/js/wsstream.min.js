!function(){"use strict";const LogLevel={Error:0,Warn:1,Log:2,Debug:3};let DEFAULT_LOG_LEVEL=LogLevel.Debug;class Logger{constructor(level=DEFAULT_LOG_LEVEL,tag){this.tag=tag,this.setLevel(level)}setLevel(level){this.level=level}static get level_map(){return{[LogLevel.Debug]:"log",[LogLevel.Log]:"log",[LogLevel.Warn]:"warn",[LogLevel.Error]:"error"}}_log(lvl,args){args=Array.prototype.slice.call(args),this.tag&&args.unshift(`[${this.tag}]`)}log(){this._log(LogLevel.Log,arguments)}debug(){this._log(LogLevel.Debug,arguments)}error(){this._log(LogLevel.Error,arguments)}warn(){this._log(LogLevel.Warn,arguments)}}const taggedLoggers=new Map;function getTagged(tag){return taggedLoggers.has(tag)||taggedLoggers.set(tag,new Logger(DEFAULT_LOG_LEVEL,tag)),taggedLoggers.get(tag)}const Log=new Logger;class Url{static parse(url){let ret={},urlparts=decodeURI(url).split(" ");url=urlparts.shift(),ret.client=urlparts.join(" ");let result=/^([^:]+):\/\/([^\/]+)(.*)$/.exec(url);if(!result)throw new Error("bad url");ret.full=url,ret.protocol=result[1],ret.urlpath=result[3];let parts=ret.urlpath.split("/");ret.basename=parts.pop().split(/\?|#/)[0],ret.basepath=parts.join("/");let loginSplit=result[2].split("@"),hostport=loginSplit[0].split(":"),userpass=[null,null];return 2===loginSplit.length&&(userpass=loginSplit[0].split(":"),hostport=loginSplit[1].split(":")),ret.user=userpass[0],ret.pass=userpass[1],ret.host=hostport[0],ret.auth=ret.user&&ret.pass?`${ret.user}:${ret.pass}`:"",ret.port=null==hostport[1]?Url.protocolDefaultPort(ret.protocol):hostport[1],ret.portDefined=null!=hostport[1],ret.location=`${ret.host}:${ret.port}`,"unix"==ret.protocol&&(ret.socket=ret.port,ret.port=void 0),ret}static full(parsed){return`${parsed.protocol}://${parsed.location}/${parsed.urlpath}`}static isAbsolute(url){return/^[^:]+:\/\//.test(url)}static protocolDefaultPort(protocol){switch(protocol){case"rtsp":return 554;case"http":return 80;case"https":return 443}return 0}}const listener=Symbol("event_listener"),listeners=Symbol("event_listeners");class DestructibleEventListener{constructor(eventListener){this[listener]=eventListener,this[listeners]=new Map}clear(){if(this[listeners])for(var entry of this[listeners])for(var fn of entry[1])this[listener].removeEventListener(entry[0],fn);this[listeners].clear()}destroy(){this.clear(),this[listeners]=null}on(event,selector,fn){return null==fn&&(fn=selector,selector=null),selector?this.addEventListener(event,e=>{e.target.matches(selector)&&fn(e)}):this.addEventListener(event,fn)}addEventListener(event,fn){return this[listeners].has(event)||this[listeners].set(event,new Set),this[listeners].get(event).add(fn),this[listener].addEventListener(event,fn,!1),fn}removeEventListener(event,fn){if(this[listener].removeEventListener(event,fn,!1),this[listeners].has(event)){let ev=this[listeners].get(event);ev.delete(fn),ev.size||this[listeners].delete(event)}}dispatchEvent(event){this[listener]&&this[listener].dispatchEvent(event)}}class EventEmitter{constructor(element=null){this[listener]=new DestructibleEventListener(element||document.createElement("div"))}clear(){this[listener]&&this[listener].clear()}destroy(){this[listener]&&(this[listener].destroy(),this[listener]=null)}on(event,selector,fn){return this[listener]?this[listener].on(event,selector,fn):null}addEventListener(event,fn){return this[listener]?this[listener].addEventListener(event,fn,!1):null}removeEventListener(event,fn){this[listener]&&this[listener].removeEventListener(event,fn,!1)}dispatchEvent(event,data){this[listener]&&this[listener].dispatchEvent(new CustomEvent(event,{detail:data}))}}class EventSourceWrapper{constructor(eventSource){this.eventSource=eventSource,this[listeners]=new Map}on(event,selector,listener){this[listeners].has(event)||this[listeners].set(event,new Set);listener=this.eventSource.on(event,selector,listener);listener&&this[listeners].get(event).add(listener)}off(event,fn){this.eventSource.removeEventListener(event,fn)}clear(){this.eventSource.clear(),this[listeners].clear()}destroy(){this.eventSource.clear(),this[listeners]=null,this.eventSource=null}}class MP4{static init(){for(var i in MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},MP4.types)MP4.types.hasOwnProperty(i)&&(MP4.types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);var majorBrand=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),avc1Brand=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);MP4.HDLR_TYPES={video:majorBrand,audio:avc1Brand};var dref=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),minorVersion=new Uint8Array([0,0,0,0,0,0,0,0]);MP4.STTS=MP4.STSC=MP4.STCO=minorVersion,MP4.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),MP4.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),MP4.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),MP4.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);majorBrand=new Uint8Array([105,115,111,109]),avc1Brand=new Uint8Array([97,118,99,49]),minorVersion=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,majorBrand,minorVersion,majorBrand,avc1Brand),MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,dref))}static box(type,...payload){for(var result,size=8,i=payload.length,len=i;i--;)size+=payload[i].byteLength;for((result=new Uint8Array(size))[0]=size>>24&255,result[1]=size>>16&255,result[2]=size>>8&255,result[3]=255&size,result.set(type,4),i=0,size=8;i<len;++i)result.set(payload[i],size),size+=payload[i].byteLength;return result}static hdlr(type){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[type])}static mdat(data){return MP4.box(MP4.types.mdat,data)}static mdhd(timescale,duration){return MP4.box(MP4.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,duration>>24,duration>>16&255,duration>>8&255,255&duration,85,196,0,0]))}static mdia(track){return MP4.box(MP4.types.mdia,MP4.mdhd(track.timescale,track.duration),MP4.hdlr(track.type),MP4.minf(track))}static mfhd(sequenceNumber){return MP4.box(MP4.types.mfhd,new Uint8Array([0,0,0,0,sequenceNumber>>24,sequenceNumber>>16&255,sequenceNumber>>8&255,255&sequenceNumber]))}static minf(track){return"audio"===track.type?MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(track)):MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(track))}static moof(sn,baseMediaDecodeTime,track){return MP4.box(MP4.types.moof,MP4.mfhd(sn),MP4.traf(track,baseMediaDecodeTime))}static moov(tracks,duration,timescale){for(var i=tracks.length,boxes=[];i--;)boxes[i]=MP4.trak(tracks[i]);return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(timescale,duration)].concat(boxes).concat(MP4.mvex(tracks)))}static mvex(tracks){for(var i=tracks.length,boxes=[];i--;)boxes[i]=MP4.trex(tracks[i]);return MP4.box.apply(null,[MP4.types.mvex].concat(boxes))}static mvhd(timescale,bytes){bytes=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,bytes>>24&255,bytes>>16&255,bytes>>8&255,255&bytes,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return MP4.box(MP4.types.mvhd,bytes)}static sdtp(track){for(var flags,samples=track.samples||[],bytes=new Uint8Array(4+samples.length),i=0;i<samples.length;i++)flags=samples[i].flags,bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;return MP4.box(MP4.types.sdtp,bytes)}static stbl(track){return MP4.box(MP4.types.stbl,MP4.stsd(track),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO))}static avc1(track){for(var data,len,sps=[],pps=[],i=0;i<track.sps.length;i++)len=(data=track.sps[i]).byteLength,sps.push(len>>>8&255),sps.push(255&len),sps=sps.concat(Array.prototype.slice.call(data));for(i=0;i<track.pps.length;i++)len=(data=track.pps[i]).byteLength,pps.push(len>>>8&255),pps.push(255&len),pps=pps.concat(Array.prototype.slice.call(data));var avcc=MP4.box(MP4.types.avcC,new Uint8Array([1,sps[3],sps[4],sps[5],255,224|track.sps.length].concat(sps).concat([track.pps.length]).concat(pps))),width=track.width,height=track.height;return MP4.box(MP4.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,width>>8&255,255&width,height>>8&255,255&height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,108,112,114,111,46,114,117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),avcc,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}static esds(track){var configlen=track.config.byteLength;let data=new Uint8Array(26+configlen+3);return data.set([0,0,0,0,3,23+configlen,0,1,0,4,15+configlen,64,21,0,0,0,0,0,0,0,0,0,0,0,5,configlen]),data.set(track.config,26),data.set([6,1,2],26+configlen),data}static mp4a(track){var audiosamplerate=track.audiosamplerate;return MP4.box(MP4.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,audiosamplerate>>8&255,255&audiosamplerate,0,0]),MP4.box(MP4.types.esds,MP4.esds(track)))}static stsd(track){return"audio"===track.type?MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(track))}static tkhd(volume){var id=volume.id,duration=volume.duration,width=volume.width,height=volume.height,volume=volume.volume;return MP4.box(MP4.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,id>>24&255,id>>16&255,id>>8&255,255&id,0,0,0,0,duration>>24,duration>>16&255,duration>>8&255,255&duration,0,0,0,0,0,0,0,0,0,0,0,0,volume>>0&255,volume%1*10>>0&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,width>>8&255,255&width,0,0,height>>8&255,255&height,0,0]))}static traf(track,baseMediaDecodeTime){var sampleDependencyTable=MP4.sdtp(track),id=track.id;return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id])),MP4.box(MP4.types.tfdt,new Uint8Array([0,0,0,0,baseMediaDecodeTime>>24,baseMediaDecodeTime>>16&255,baseMediaDecodeTime>>8&255,255&baseMediaDecodeTime])),MP4.trun(track,sampleDependencyTable.length+16+16+8+16+8+8),sampleDependencyTable)}static trak(track){return track.duration=track.duration||4294967295,MP4.box(MP4.types.trak,MP4.tkhd(track),MP4.mdia(track))}static trex(id){id=id.id;return MP4.box(MP4.types.trex,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(arraylen,offset){var i,duration,size,flags,cts,samples=arraylen.samples||[],len=samples.length,arraylen=12+16*len,array=new Uint8Array(arraylen);for(array.set([0,0,15,1,len>>>24&255,len>>>16&255,len>>>8&255,255&len,(offset+=8+arraylen)>>>24&255,offset>>>16&255,offset>>>8&255,255&offset],0),i=0;i<len;i++)duration=(cts=samples[i]).duration,size=cts.size,flags=cts.flags,cts=cts.cts,array.set([duration>>>24&255,duration>>>16&255,duration>>>8&255,255&duration,size>>>24&255,size>>>16&255,size>>>8&255,255&size,flags.isLeading<<2|flags.dependsOn,flags.isDependedOn<<6|flags.hasRedundancy<<4|flags.paddingValue<<1|flags.isNonSync,61440&flags.degradPrio,15&flags.degradPrio,cts>>>24&255,cts>>>16&255,cts>>>8&255,255&cts],12+16*i);return MP4.box(MP4.types.trun,array)}static initSegment(tracks,movie,result){MP4.types||MP4.init();movie=MP4.moov(tracks,movie,result),result=new Uint8Array(MP4.FTYP.byteLength+movie.byteLength);return result.set(MP4.FTYP),result.set(movie,MP4.FTYP.byteLength),result}}const Log$1=getTagged("mse");class MSEBuffer{constructor(parent,codec){this.mediaSource=parent.mediaSource,this.players=parent.players,this.cleaning=!1,this.parent=parent,this.queue=[],this.cleanResolvers=[],this.codec=codec,this.cleanRanges=[],this.updatesToCleanup=0,this.firstMoveToBufferStart=!0,Log$1.debug(`Use codec: ${codec}`),this.sourceBuffer=this.mediaSource.addSourceBuffer(codec),this.eventSource=new EventEmitter(this.sourceBuffer),this.eventSource.addEventListener("updatestart",e=>{this.cleaning&&Log$1.debug(`${this.codec} cleaning start`)}),this.eventSource.addEventListener("update",e=>{this.cleaning&&Log$1.debug(`${this.codec} cleaning update`)}),this.eventSource.addEventListener("updateend",e=>{if(this.cleaning){Log$1.debug(`${this.codec} cleaning end`);try{this.sourceBuffer.buffered.length&&this.players[0].currentTime<this.sourceBuffer.buffered.start(0)&&(this.players[0].currentTime=this.sourceBuffer.buffered.start(0))}catch(e){}for(;this.cleanResolvers.length;){let resolver=this.cleanResolvers.shift();resolver()}if(this.cleaning=!1,this.cleanRanges.length)return void this.doCleanup()}this.updatesToCleanup++,100<this.updatesToCleanup&&(this.cleanupBuffer(),this.updatesToCleanup=0),this.feedNext()}),this.eventSource.addEventListener("error",e=>{Log$1.debug(`Source buffer error: ${this.mediaSource.readyState}`),this.mediaSource.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(this.sourceBuffer),this.parent.eventSource.dispatchEvent("error")}),this.eventSource.addEventListener("abort",e=>{Log$1.debug(`Source buffer aborted: ${this.mediaSource.readyState}`),this.mediaSource.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(this.sourceBuffer),this.parent.eventSource.dispatchEvent("error")}),this.sourceBuffer.updating||this.feedNext()}cleanupBuffer(){if(this.sourceBuffer.buffered.length&&!this.sourceBuffer.updating){var currentPlayTime=this.players[0].currentTime,startBuffered=this.sourceBuffer.buffered.start(0),endBuffered=this.sourceBuffer.buffered.end(0),removeEnd=endBuffered-this.parent.bufferDuration;if(0<removeEnd&&endBuffered-startBuffered>this.parent.bufferDuration&&startBuffered<currentPlayTime&&removeEnd<currentPlayTime)try{Log$1.debug("Remove media segments",startBuffered,removeEnd),this.sourceBuffer.remove(startBuffered,removeEnd)}catch(e){Log$1.warn("Failed to cleanup buffer")}}}destroy(){this.eventSource.destroy(),this.clear(),this.queue=[],this.mediaSource.removeSourceBuffer(this.sourceBuffer)}clear(){this.queue=[];let promises=[];for(let i=0;i<this.sourceBuffer.buffered.length;++i)this.cleaning=!0,promises.push(new Promise((resolve,reject)=>{this.cleanResolvers.push(resolve),this.sourceBuffer.updating?this.sourceBuffer.onupdateend=()=>{this.sourceBuffer&&this.sourceBuffer.remove(this.sourceBuffer.buffered.start(i),this.sourceBuffer.buffered.end(i)),resolve()}:(this.sourceBuffer.remove(this.sourceBuffer.buffered.start(i),this.sourceBuffer.buffered.end(i)),resolve())}));return Promise.all(promises)}setLive(is_live){this.is_live=is_live}feedNext(){this.sourceBuffer.updating||this.cleaning||!this.queue.length||this.doAppend(this.queue.shift())}doCleanup(){if(!this.cleanRanges.length)return this.cleaning=!1,void this.feedNext();var range=this.cleanRanges.shift();Log$1.debug(`${this.codec} remove range [${range[0]} - ${range[1]}). 
                    \nUpdating: ${this.sourceBuffer.updating}
                    `),this.cleaning=!0,this.sourceBuffer.remove(range[0],range[1])}initCleanup(){if(!this.sourceBuffer.buffered.length||this.sourceBuffer.updating||this.cleaning)this.feedNext();else{Log$1.debug(`${this.codec} cleanup`);var removeBound=this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)-2;for(let i=0;i<this.sourceBuffer.buffered.length;++i){var removeStart=this.sourceBuffer.buffered.start(i);let removeEnd=this.sourceBuffer.buffered.end(i);this.players[0].currentTime<=removeStart||removeBound<=removeStart||(removeBound<=removeEnd&&removeStart<=removeBound?(Log$1.debug(`Clear [${removeStart}, ${removeBound}), leave [${removeBound}, ${removeEnd}]`),removeEnd=removeBound,removeEnd!=removeStart&&this.cleanRanges.push([removeStart,removeEnd])):this.cleanRanges.push([removeStart,removeEnd]))}this.doCleanup()}}doAppend(data){var err=this.players[0].error;if(err){Log$1.error(`Error occured: ${MSE.ErrorNotes[err.code]}`);try{this.players.forEach(video=>{video.stop()}),this.mediaSource.endOfStream()}catch(e){}this.parent.eventSource.dispatchEvent("error")}else try{this.sourceBuffer.appendBuffer(data),this.firstMoveToBufferStart&&this.sourceBuffer.buffered.length&&(this.players[0].currentTime=this.sourceBuffer.buffered.start(0),this.players[0].autoPlay&&this.players[0].start(),this.firstMoveToBufferStart=!1)}catch(e){if("QuotaExceededError"===e.name)return Log$1.debug(`${this.codec} quota fail`),this.queue.unshift(data),void this.initCleanup();Log$1.error(`Error occured while appending buffer. ${e.name}: ${e.message}`),this.parent.eventSource.dispatchEvent("error")}}feed(data){this.queue=this.queue.concat(data),!this.sourceBuffer||this.sourceBuffer.updating||this.cleaning||this.feedNext()}}class MSE{static get ErrorNotes(){return{[MediaError.MEDIA_ERR_ABORTED]:"fetching process aborted by user",[MediaError.MEDIA_ERR_NETWORK]:"error occurred when downloading",[MediaError.MEDIA_ERR_DECODE]:"error occurred when decoding",[MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED]:"audio/video not supported"}}static isSupported(codecs){return window.MediaSource&&window.MediaSource.isTypeSupported(`video/mp4; codecs="${codecs.join(",")}"`)}constructor(players){this.players=players;const playing=this.players.map((video,idx)=>(video.onplaying=function(){playing[idx]=!0},video.onpause=function(){playing[idx]=!1},!video.paused));this.playing=playing,this.mediaSource=new MediaSource,this.eventSource=new EventEmitter(this.mediaSource),this.reset()}set bufferDuration(buffDuration){this.bufferDuration_=buffDuration}get bufferDuration(){return this.bufferDuration_}destroy(){this.reset(),this.eventSource.destroy(),this.mediaSource=null,this.eventSource=null}play(){this.players.forEach((video,idx)=>{video.paused&&!this.playing[idx]&&(Log$1.debug(`player ${idx}: play`),video.play())})}setLive(is_live){for(var idx in this.buffers)this.buffers[idx].setLive(is_live);this.is_live=is_live}resetBuffers(){this.players.forEach((video,idx)=>{!video.paused&&this.playing[idx]&&(video.pause(),video.currentTime=0)});let promises=[];for(var buffer of this.buffers.values())promises.push(buffer.clear());return Promise.all(promises).then(()=>{this.mediaSource.endOfStream(),this.mediaSource.duration=0,this.mediaSource.clearLiveSeekableRange(),this.play()})}clear(){return this.reset(),this.players.forEach(video=>{video.src=URL.createObjectURL(this.mediaSource)}),this.setupEvents()}setupEvents(){return this.eventSource.clear(),this.resolved=!1,this.mediaReady=new Promise((resolve,reject)=>{this._sourceOpen=()=>{Log$1.debug(`Media source opened: ${this.mediaSource.readyState}`),this.resolved||(this.resolved=!0,resolve())},this._sourceEnded=()=>{Log$1.debug(`Media source ended: ${this.mediaSource.readyState}`)},this._sourceClose=()=>{Log$1.debug(`Media source closed: ${this.mediaSource.readyState}`),this.resolved&&this.eventSource.dispatchEvent("sourceclosed")},this.eventSource.addEventListener("sourceopen",this._sourceOpen),this.eventSource.addEventListener("sourceended",this._sourceEnded),this.eventSource.addEventListener("sourceclose",this._sourceClose)}),this.mediaReady}reset(){for(var track in this.ready=!1,this.buffers)this.buffers[track].destroy(),delete this.buffers[track];"open"==this.mediaSource.readyState&&(this.mediaSource.duration=0,this.mediaSource.endOfStream()),this.updating=!1,this.resolved=!1,this.buffers={}}setCodec(track,mimeCodec){return this.mediaReady.then(()=>{this.buffers[track]=new MSEBuffer(this,mimeCodec),this.buffers[track].setLive(this.is_live)})}feed(track,data){this.buffers[track]&&this.buffers[track].feed(data)}}const Log$2=getTagged("remuxer:base");let track_id=1;class BaseRemuxer{static get MP4_TIMESCALE(){return 9e4}static getTrackID(){return track_id++}constructor(timescale,scaleFactor,params){this.timeOffset=0,this.timescale=timescale,this.scaleFactor=scaleFactor,this.readyToDecode=!1,this.samples=[],this.seq=1,this.tsAlign=1}scaled(timestamp){return timestamp/this.scaleFactor}unscaled(timestamp){return timestamp*this.scaleFactor}remux(unit){return!!unit&&(this.samples.push({unit:unit,pts:unit.pts,dts:unit.dts}),!0)}static toMS(timestamp){return timestamp/90}setConfig(config){}insertDscontinuity(){this.samples.push(null)}init(initPTS,initDTS,shouldInitialize=!0){this.initPTS=Math.min(initPTS,this.samples[0].dts),this.initDTS=Math.min(initDTS,this.samples[0].dts),Log$2.debug(`Initial pts=${this.initPTS} dts=${this.initDTS} offset=${this.unscaled(this.timeOffset)}`),this.initialized=shouldInitialize}flush(){this.seq++,this.mp4track.len=0,this.mp4track.samples=[]}static dtsSortFunc(a,b){return a.dts-b.dts}static groupByDts(gop){var key;return key="dts",gop.reduce((rv,x)=>((rv[x[key]]=rv[x[key]]||[]).push(x),rv),{})}getPayloadBase(sampleFunction,setupSample){return this.readyToDecode&&this.initialized&&this.samples.length?(this.samples.sort(BaseRemuxer.dtsSortFunc),!0):null}}const Log$3=getTagged("remuxer:aac");class AACRemuxer extends BaseRemuxer{constructor(timescale,scaleFactor=1,params={}){super(timescale,scaleFactor),this.codecstring=MSE.CODEC_AAC,this.units=[],this.initDTS=void 0,this.nextAacPts=void 0,this.lastPts=0,this.firstDTS=0,this.firstPTS=0,this.duration=params.duration||1,this.initialized=!1,this.mp4track={id:BaseRemuxer.getTrackID(),type:"audio",fragmented:!0,channelCount:0,audiosamplerate:this.timescale,duration:0,timescale:this.timescale,volume:1,samples:[],config:"",len:0},params.config&&this.setConfig(params.config)}setConfig(config){this.mp4track.channelCount=config.channels,this.mp4track.audiosamplerate=config.samplerate,this.mp4track.duration||(this.mp4track.duration=(this.duration||1)*config.samplerate),this.mp4track.timescale=config.samplerate,this.mp4track.config=config.config,this.mp4track.codec=config.codec,this.timescale=config.samplerate,this.scaleFactor=BaseRemuxer.MP4_TIMESCALE/config.samplerate,this.expectedSampleDuration=1024*this.scaleFactor,this.readyToDecode=!0}remux(aac){super.remux.call(this,aac)&&(this.mp4track.len+=aac.getSize())}getPayload(){if(!this.readyToDecode||!this.samples.length)return null;this.samples.sort(function(a,b){return a.dts-b.dts});let payload=new Uint8Array(this.mp4track.len),offset=0,samples=this.mp4track.samples,mp4Sample,lastDTS,pts,dts;for(;this.samples.length;){var delta=this.samples.shift();if(null===delta){this.nextDts=void 0;break}let unit=delta.unit;if(pts=delta.pts-this.initDTS,dts=delta.dts-this.initDTS,void 0===lastDTS){if(this.nextDts){delta=Math.round(this.scaled(pts-this.nextAacPts));if(Math.abs(delta)<600&&delta){if(0<delta)Log$3.log(`${delta} ms hole between AAC samples detected,filling it`);else if(delta<-12){Log$3.log(`${-delta} ms overlapping between AAC samples detected, drop frame`),this.mp4track.len-=unit.getSize();continue}pts=dts=this.nextAacPts}}this.firstDTS=Math.max(0,dts)}mp4Sample={size:unit.getSize(),cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},payload.set(unit.getData(),offset),offset+=unit.getSize(),samples.push(mp4Sample),lastDTS=dts}return samples.length?(this.nextDts=pts+this.expectedSampleDuration,new Uint8Array(payload.buffer,0,this.mp4track.len)):null}}class ExpGolomb{constructor(data){this.data=data,this.bytesAvailable=this.data.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){var position=this.data.byteLength-this.bytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,this.bytesAvailable);if(0===availableBytes)throw new Error("no bytes available");workingBytes.set(this.data.subarray(position,position+availableBytes)),this.word=new DataView(workingBytes.buffer,workingBytes.byteOffset,workingBytes.byteLength).getUint32(0),this.bitsAvailable=8*availableBytes,this.bytesAvailable-=availableBytes}skipBits(count){var skipBytes;this.bitsAvailable>count||(count-=this.bitsAvailable,count-=(skipBytes=count>>3)<<3,this.bytesAvailable-=skipBytes,this.loadWord()),this.word<<=count,this.bitsAvailable-=count}readBits(size){var bits=Math.min(this.bitsAvailable,size),valu=this.word>>>32-bits;return 32<size&&Log.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=bits,0<this.bitsAvailable?this.word<<=bits:0<this.bytesAvailable&&this.loadWord(),0<(bits=size-bits)?valu<<bits|this.readBits(bits):valu}skipLZ(){for(var leadingZeroCount=0;leadingZeroCount<this.bitsAvailable;++leadingZeroCount)if(0!=(this.word&2147483648>>>leadingZeroCount))return this.word<<=leadingZeroCount,this.bitsAvailable-=leadingZeroCount,leadingZeroCount;return this.loadWord(),leadingZeroCount+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var clz=this.skipLZ();return this.readBits(clz+1)-1}readEG(){var valu=this.readUEG();return 1&valu?1+valu>>>1:-1*(valu>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}function base64ToArrayBuffer(base64){for(var binary_string=window.atob(base64),len=binary_string.length,bytes=new Uint8Array(len),i=0;i<len;i++)bytes[i]=binary_string.charCodeAt(i);return bytes.buffer}function hexToByteArray(hex){for(var len=hex.length>>1,bufView=new Uint8Array(len),i=0;i<len;i++)bufView[i]=parseInt(hex.substr(i<<1,2),16);return bufView}class BitArray{constructor(src){this.src=new DataView(src.buffer,src.byteOffset,src.byteLength),this.bitpos=0,this.byte=this.src.getUint8(0),this.bytepos=0}readBits(length){if(32<(0|length)||0==(0|length))throw new Error("too big");let result=0;for(let i=length;0<i;--i)result=(0|result)<<1|(0|this.byte)>>8-++this.bitpos&1,8<=(0|this.bitpos)&&(this.byte=this.src.getUint8(++this.bytepos),this.bitpos&=7);return result}skipBits(length){return this.bitpos+=7&(0|length),this.bytepos+=(0|length)>>>3,7<this.bitpos&&(this.bitpos&=7,++this.bytepos),this.finished()?this.bytepos-this.src.byteLength-this.src.bitpos:(this.byte=this.src.getUint8(this.bytepos),0)}finished(){return this.bytepos>=this.src.byteLength}}class NALU{static get NDR(){return 1}static get SLICE_PART_A(){return 2}static get SLICE_PART_B(){return 3}static get SLICE_PART_C(){return 4}static get IDR(){return 5}static get SEI(){return 6}static get SPS(){return 7}static get PPS(){return 8}static get DELIMITER(){return 9}static get EOSEQ(){return 10}static get EOSTR(){return 11}static get FILTER(){return 12}static get STAP_A(){return 24}static get STAP_B(){return 25}static get FU_A(){return 28}static get FU_B(){return 29}static get TYPES(){return{[NALU.IDR]:"IDR",[NALU.SEI]:"SEI",[NALU.SPS]:"SPS",[NALU.PPS]:"PPS",[NALU.NDR]:"NDR"}}static type(nalu){return nalu.ntype in NALU.TYPES?NALU.TYPES[nalu.ntype]:"UNKNOWN"}constructor(ntype,nri,data,dts,pts){this.data=data,this.ntype=ntype,this.nri=nri,this.dts=dts,this.pts=pts||this.dts,this.sliceType=null}appendData(idata){this.data=function(buffer1,buffer2){let tmp=new Uint8Array((0|buffer1.byteLength)+(0|buffer2.byteLength));return tmp.set(buffer1,0),tmp.set(buffer2,0|buffer1.byteLength),tmp}(this.data,idata)}toString(){return`${NALU.type(this)}(${this.data.byteLength}): NRI: ${this.getNri()}, PTS: ${this.pts}, DTS: ${this.dts}`}getNri(){return this.nri>>5}type(){return this.ntype}isKeyframe(){return this.ntype===NALU.IDR||7===this.sliceType}getSize(){return 5+this.data.byteLength}getData(){let header=new Uint8Array(5+this.data.byteLength),view=new DataView(header.buffer);return view.setUint32(0,this.data.byteLength+1),view.setUint8(4,0|96&this.nri|31&this.ntype),header.set(this.data,5),header}}class H264Parser{constructor(remuxer){this.remuxer=remuxer,this.track=remuxer.mp4track,this.firstFound=!1}msToScaled(timestamp){return(timestamp-this.remuxer.timeOffset)*this.remuxer.scaleFactor}parseSPS(sps){var config=H264Parser.readSPS(new Uint8Array(sps));this.track.width=config.width,this.track.height=config.height,this.track.sps=[new Uint8Array(sps)],this.track.codec="avc1.";let codecarray=new DataView(sps.buffer,sps.byteOffset+1,4);for(let i=0;i<3;++i){var h=codecarray.getUint8(i).toString(16);h.length<2&&(h="0"+h),this.track.codec+=h}}parsePPS(pps){this.track.pps=[new Uint8Array(pps)]}parseNAL(unit){if(!unit)return!1;let push=null;switch(unit.type()){case NALU.NDR:case NALU.IDR:unit.sliceType=H264Parser.parceSliceHeader(unit.data),unit.isKeyframe()&&!this.firstFound&&(this.firstFound=!0),push=!!this.firstFound;break;case NALU.PPS:push=!1,this.track.pps||(this.parsePPS(unit.getData().subarray(4)),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0));break;case NALU.SPS:push=!1,this.firstFound||navigator.vendor.match(/apple/i)||navigator.platform.match(/linux/i)||(this.firstFound=!0,push=!0),this.track.sps||(this.parseSPS(unit.getData().subarray(4)),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0));break;case NALU.SEI:push=!1;let data=new DataView(unit.data.buffer,unit.data.byteOffset,unit.data.byteLength),byte_idx=0;var pay_type=data.getUint8(byte_idx);++byte_idx;let pay_size=0,sz=data.getUint8(byte_idx);for(++byte_idx;255===sz;)pay_size+=sz,sz=data.getUint8(byte_idx),++byte_idx;pay_size+=sz;var uuid=unit.data.subarray(byte_idx,byte_idx+16);byte_idx+=16,console.log(`PT: ${pay_type}, PS: ${pay_size}, UUID: ${Array.from(uuid).map(function(i){return("0"+i.toString(16)).slice(-2)}).join("")}`);break;case NALU.EOSEQ:case NALU.EOSTR:push=!1}return null===push&&0<unit.getNri()&&(push=!0),push}static parceSliceHeader(slice_type){let decoder=new ExpGolomb(slice_type);decoder.readUEG();slice_type=decoder.readUEG(),decoder.readUEG(),decoder.readUByte();return slice_type}static skipScalingList(decoder,count){let lastScale=8,nextScale=8,deltaScale;for(let j=0;j<count;j++)0!==nextScale&&(deltaScale=decoder.readEG(),nextScale=(lastScale+deltaScale+256)%256),lastScale=0===nextScale?lastScale:nextScale}static readSPS(unitsInTick){let decoder=new ExpGolomb(unitsInTick),frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,sarScale=1,profileIdc,numRefFramesInPicOrderCntCycle,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,scalingListCount;if(decoder.readUByte(),profileIdc=decoder.readUByte(),decoder.readBits(5),decoder.skipBits(3),decoder.readUByte(),decoder.skipUEG(),100===profileIdc||110===profileIdc||122===profileIdc||244===profileIdc||44===profileIdc||83===profileIdc||86===profileIdc||118===profileIdc||128===profileIdc){var timeScale=decoder.readUEG();if(3===timeScale&&decoder.skipBits(1),decoder.skipUEG(),decoder.skipUEG(),decoder.skipBits(1),decoder.readBoolean()){scalingListCount=3!==timeScale?8:12;for(let i=0;i<scalingListCount;++i)decoder.readBoolean()&&(i<6?H264Parser.skipScalingList(decoder,16):H264Parser.skipScalingList(decoder,64))}}decoder.skipUEG();var fixedFrameRate=decoder.readUEG();if(0===fixedFrameRate)decoder.readUEG();else if(1===fixedFrameRate){decoder.skipBits(1),decoder.skipEG(),decoder.skipEG(),numRefFramesInPicOrderCntCycle=decoder.readUEG();for(let i=0;i<numRefFramesInPicOrderCntCycle;++i)decoder.skipEG()}if(decoder.skipUEG(),decoder.skipBits(1),picWidthInMbsMinus1=decoder.readUEG(),picHeightInMapUnitsMinus1=decoder.readUEG(),0===(frameMbsOnlyFlag=decoder.readBits(1))&&decoder.skipBits(1),decoder.skipBits(1),decoder.readBoolean()&&(frameCropLeftOffset=decoder.readUEG(),frameCropRightOffset=decoder.readUEG(),frameCropTopOffset=decoder.readUEG(),frameCropBottomOffset=decoder.readUEG()),decoder.readBoolean()){if(decoder.readBoolean()){let sarRatio;switch(decoder.readUByte()){case 1:sarRatio=[1,1];break;case 2:sarRatio=[12,11];break;case 3:sarRatio=[10,11];break;case 4:sarRatio=[16,11];break;case 5:sarRatio=[40,33];break;case 6:sarRatio=[24,11];break;case 7:sarRatio=[20,11];break;case 8:sarRatio=[32,11];break;case 9:sarRatio=[80,33];break;case 10:sarRatio=[18,11];break;case 11:sarRatio=[15,11];break;case 12:sarRatio=[64,33];break;case 13:sarRatio=[160,99];break;case 14:sarRatio=[4,3];break;case 15:sarRatio=[3,2];break;case 16:sarRatio=[2,1];break;case 255:sarRatio=[decoder.readUByte()<<8|decoder.readUByte(),decoder.readUByte()<<8|decoder.readUByte()]}sarRatio&&(sarScale=sarRatio[0]/sarRatio[1])}decoder.readBoolean()&&decoder.skipBits(1),decoder.readBoolean()&&(decoder.skipBits(4),decoder.readBoolean()&&decoder.skipBits(24)),decoder.readBoolean()&&(decoder.skipUEG(),decoder.skipUEG()),decoder.readBoolean()&&(unitsInTick=decoder.readUInt(),timeScale=decoder.readUInt(),fixedFrameRate=decoder.readBoolean(),console.log(`timescale: ${timeScale}; unitsInTick: ${unitsInTick}; fixedFramerate: ${fixedFrameRate}; avgFrameDuration: ${timeScale/(2*unitsInTick)}`))}return{width:Math.ceil((16*(picWidthInMbsMinus1+1)-2*frameCropLeftOffset-2*frameCropRightOffset)*sarScale),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-(frameMbsOnlyFlag?2:4)*(frameCropTopOffset+frameCropBottomOffset)}}static readSliceType(decoder){return decoder.readUByte(),decoder.readUEG(),decoder.readUEG()}}const Log$4=getTagged("remuxer:h264");class H264Remuxer extends BaseRemuxer{constructor(arr,scaleFactor=1,params={}){var arr;super(arr,scaleFactor),this.nextDts=void 0,this.readyToDecode=!1,this.initialized=!1,this.firstDTS=0,this.firstPTS=0,this.lastDTS=void 0,this.lastSampleDuration=0,this.lastDurations=[],this.tsAlign=Math.round(this.timescale/60),this.mp4track={id:BaseRemuxer.getTrackID(),type:"video",len:0,fragmented:!0,sps:"",pps:"",width:0,height:0,timescale:arr,duration:arr,samples:[]},this.samples=[],this.lastGopDTS=-99999999999999,this.gop=[],this.firstUnit=!0,this.h264=new H264Parser(this),params.sps&&(7==(31&(arr=new Uint8Array(params.sps))[0])?this.setSPS(arr):Log$4.warn("bad SPS in SDP")),params.pps&&(8==(31&(arr=new Uint8Array(params.pps))[0])?this.setPPS(arr):Log$4.warn("bad PPS in SDP")),this.mp4track.pps&&this.mp4track.sps&&(this.readyToDecode=!0)}_scaled(timestamp){return timestamp>>>this.scaleFactor}_unscaled(timestamp){return timestamp<<this.scaleFactor}setSPS(sps){this.h264.parseSPS(sps)}setPPS(pps){this.h264.parsePPS(pps)}remux(nalu){if(this.lastGopDTS<nalu.dts){var groupedGop,unit;this.gop.sort(BaseRemuxer.dtsSortFunc),1<this.gop.length&&(groupedGop=BaseRemuxer.groupByDts(this.gop),this.gop=Object.values(groupedGop).map(group=>group.reduce((preUnit,curUnit)=>{const naluData=curUnit.getData();return naluData.set(new Uint8Array([0,0,0,1])),preUnit.appendData(naluData),preUnit})));for(unit of this.gop)super.remux.call(this,unit)&&(this.mp4track.len+=unit.getSize());this.gop=[],this.lastGopDTS=nalu.dts}this.h264.parseNAL(nalu)&&this.gop.push(nalu)}getPayload(){if(!this.getPayloadBase())return null;let payload=new Uint8Array(this.mp4track.len),offset=0,samples=this.mp4track.samples,mp4Sample,lastDTS,pts,dts;for(;this.samples.length;){let sample=this.samples.shift();if(null===sample){this.nextDts=void 0;break}let unit=sample.unit;if(pts=sample.pts-this.initDTS,dts=sample.dts-this.initDTS,dts=Math.min(pts,dts),void 0!==lastDTS){var delta=this.scaled(dts-lastDTS);if(delta<0){Log$4.log(`invalid AVC sample duration at PTS/DTS: ${pts}/${dts}|lastDTS: ${lastDTS}:${delta}`),this.mp4track.len-=unit.getSize();continue}this.lastDurations.push(delta),100<this.lastDurations.length&&this.lastDurations.shift(),mp4Sample.duration=delta}else{if(this.nextDts){delta=dts-this.nextDts;if(Math.abs(Math.round(BaseRemuxer.toMS(delta)))<600)delta&&(dts=this.nextDts,pts=Math.max(pts-delta,dts));else if(delta<0){Log$4.log(`skip frame from the past at DTS=${dts} with expected DTS=${this.nextDts}`),this.mp4track.len-=unit.getSize();continue}}this.firstDTS=Math.max(0,dts)}mp4Sample={size:unit.getSize(),duration:0,cts:this.scaled(pts-dts),flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0}};let flags=mp4Sample.flags;!0===sample.unit.isKeyframe()?(flags.dependsOn=2,flags.isNonSync=0):(flags.dependsOn=1,flags.isNonSync=1),payload.set(unit.getData(),offset),offset+=unit.getSize(),samples.push(mp4Sample),lastDTS=dts}if(!samples.length)return null;var avgDuration=this.lastDurations.reduce(function(a,b){return(0|a)+(0|b)},0)/(this.lastDurations.length||1)|0;if(2<=samples.length?(this.lastSampleDuration=avgDuration,mp4Sample.duration=avgDuration):0==this.lastSampleDuration?(null==this.lastDTS?this.lastDTS=dts:this.lastSampleDuration=dts-this.lastDTS,mp4Sample.duration=9e4):mp4Sample.duration=this.lastSampleDuration,samples.length&&(!this.nextDts||-1<navigator.userAgent.toLowerCase().indexOf("chrome"))){let flags=samples[0].flags;flags.dependsOn=2,flags.isNonSync=0}return this.nextDts=dts+this.unscaled(this.lastSampleDuration),new Uint8Array(payload.buffer,0,this.mp4track.len)}}class PayloadType{static get H264(){return 1}static get AAC(){return 2}static get map(){return{[PayloadType.H264]:"video",[PayloadType.AAC]:"audio"}}static get string_map(){return{H264:PayloadType.H264,AAC:PayloadType.AAC,"MP4A-LATM":PayloadType.AAC,"MPEG4-GENERIC":PayloadType.AAC}}}const Log$5=getTagged("remuxer");class Remuxer{static get TrackConverters(){return{[PayloadType.H264]:H264Remuxer,[PayloadType.AAC]:AACRemuxer}}static get TrackScaleFactor(){return{[PayloadType.H264]:1,[PayloadType.AAC]:0}}static get TrackTimescale(){return{[PayloadType.H264]:9e4,[PayloadType.AAC]:0}}constructor(mediaElement){this.mse=new MSE([mediaElement]),this.eventSource=new EventEmitter,this.mseEventSource=new EventSourceWrapper(this.mse.eventSource),this.mse_ready=!0,this.reset(),this.errorListener=this.mseClose.bind(this),this.closeListener=this.mseClose.bind(this),this.errorDecodeListener=this.mseErrorDecode.bind(this),this.eventSource.addEventListener("ready",this.init.bind(this))}initMSEHandlers(){this.mseEventSource.on("error",this.errorListener),this.mseEventSource.on("sourceclosed",this.closeListener),this.mseEventSource.on("errordecode",this.errorDecodeListener)}async reset(){this.tracks={},this.initialized=!1,this.initSegments={},this.codecs=[],this.streams={},this.enabled=!1,await this.mse.clear(),this.initMSEHandlers()}destroy(){this.mseEventSource.destroy(),this.mse.destroy(),this.mse=null,this.detachClient(),this.eventSource.destroy()}onTracks(tracks){Log$5.debug("ontracks: ",tracks.detail);for(var track of tracks.detail)this.tracks[track.type]=new Remuxer.TrackConverters[track.type](Remuxer.TrackTimescale[track.type],Remuxer.TrackScaleFactor[track.type],track.params),track.offset&&(this.tracks[track.type].timeOffset=track.offset),track.duration?(this.tracks[track.type].mp4track.duration=track.duration*(this.tracks[track.type].timescale||Remuxer.TrackTimescale[track.type]),this.tracks[track.type].duration=track.duration):this.tracks[track.type].duration=1;this.mse.setLive(!this.client.seekable)}setTimeOffset(timeOffset,track){this.tracks[track.type]&&(this.tracks[track.type].timeOffset=timeOffset)}get MSE(){return this.mse}init(){let tracks=[];this.codecs=[];let initmse=[];var track_type,track_type;for(track_type in this.tracks){let track=this.tracks[track_type];if(!MSE.isSupported([track.mp4track.codec]))throw new Error(`${track.mp4track.type} codec ${track.mp4track.codec} is not supported`);tracks.push(track.mp4track),this.codecs.push(track.mp4track.codec),track.init(1/0,1/0)}for(track_type in this.tracks){var track=this.tracks[track_type];this.initSegments[track_type]=MP4.initSegment([track.mp4track],track.duration*track.timescale,track.timescale),initmse.push(this.initMSE(track_type,track.mp4track.codec))}return this.initialized=!0,Promise.all(initmse).then(()=>{this.enabled=!0})}initMSE(track_type,codec){if(MSE.isSupported(this.codecs))return this.mse.setCodec(track_type,`${PayloadType.map[track_type]}/mp4; codecs="${codec}"`).then(()=>{this.mse.feed(track_type,this.initSegments[track_type])});throw new Error("Codecs are not supported")}mseClose(){this.client.stop(),this.eventSource.dispatchEvent("stopped")}mseErrorDecode(){this.tracks[2]&&(console.warn(this.tracks[2].mp4track.type),this.mse.buffers[2].destroy(),delete this.tracks[2])}flush(){if(this.onSamples(),this.initialized)for(var track_type in this.tracks){let track=this.tracks[track_type];var pay=track.getPayload();pay&&pay.byteLength&&(this.mse.feed(track_type,[MP4.moof(track.seq,track.scaled(track.firstDTS),track.mp4track),MP4.mdat(pay)]),track.flush())}else if(Object.keys(this.tracks).length){for(var track_type in this.tracks){if(!this.tracks[track_type].readyToDecode||!this.tracks[track_type].samples.length)return;Log$5.debug(`Init MSE for track ${this.tracks[track_type].mp4track.type}`)}this.eventSource.dispatchEvent("ready")}}onSamples(ev){for(var qidx in this.client.sampleQueues){let queue=this.client.sampleQueues[qidx];for(;queue.length;){var units=queue.shift();if(units)for(var chunk of units)this.tracks[qidx]&&this.tracks[qidx].remux(chunk)}}}onAudioConfig(ev){this.tracks[ev.detail.pay]&&this.tracks[ev.detail.pay].setConfig(ev.detail.config)}attachClient(client){this.detachClient(),this.client=client,this.clientEventSource=new EventSourceWrapper(this.client.eventSource),this.clientEventSource.on("samples",this.samplesListener),this.clientEventSource.on("audio_config",this.audioConfigListener),this.clientEventSource.on("tracks",this.onTracks.bind(this)),this.clientEventSource.on("flush",this.flush.bind(this)),this.clientEventSource.on("clear",()=>{this.reset(),this.mse.clear().then(()=>{this.initMSEHandlers()})})}detachClient(){this.client&&(this.clientEventSource.destroy(),this.client=null)}}class State{constructor(name,stateMachine){this.stateMachine=stateMachine,this.transitions=new Set,this.name=name}activate(){return Promise.resolve(null)}finishTransition(){}failHandler(){}deactivate(){return Promise.resolve(null)}}const Log$6=getTagged("parser:sdp");class SDPParser{constructor(){this.version=-1,this.origin=null,this.sessionName=null,this.timing=null,this.sessionBlock={},this.media={},this.tracks={},this.mediaMap={}}parse(content){return new Promise((resolve,reject)=>{var line,success=!0,currentMediaBlock=this.sessionBlock;for(line of content.split("\n"))if(line=line.replace(/\r/,""),0!==line.length){switch(line.charAt(0)){case"v":if(-1!==this.version)return Log$6.log("Version present multiple times in SDP"),reject(),!1;success=success&&this._parseVersion(line);break;case"o":if(null!==this.origin)return Log$6.log("Origin present multiple times in SDP"),reject(),!1;this._parseOrigin(line),success=!0;break;case"s":if(null!==this.sessionName)return Log$6.log("Session Name present multiple times in SDP"),reject(),!1;success=success&&this._parseSessionName(line);break;case"t":if(null!==this.timing)return Log$6.log("Timing present multiple times in SDP"),reject(),!1;success=success&&this._parseTiming(line);break;case"m":null!==currentMediaBlock&&this.sessionBlock!==currentMediaBlock&&(this.media[currentMediaBlock.type]=currentMediaBlock),currentMediaBlock={rtpmap:{}},this._parseMediaDescription(line,currentMediaBlock);break;case"a":SDPParser._parseAttribute(line,currentMediaBlock);break;default:Log$6.log("Ignored unknown SDP directive: "+line)}if(!success)return void reject()}this.media[currentMediaBlock.type]=currentMediaBlock,(success?resolve:reject)()})}_parseVersion(line){var matches=line.match(/^v=([0-9]+)$/);return matches&&matches.length?(this.version=matches[1],0==this.version||(Log$6.log("Unsupported SDP version:"+this.version),!1)):(Log$6.log("'v=' (Version) formatted incorrectly: "+line),!1)}_parseOrigin(line){var matches=line.match(/^o=([^ ]+) (-?[0-9]+) (-?[0-9]+) (IN) (IP4|IP6) ([^ ]+)$/);return matches&&matches.length?(this.origin={},this.origin.username=matches[1],this.origin.sessionid=matches[2],this.origin.sessionversion=matches[3],this.origin.nettype=matches[4],this.origin.addresstype=matches[5],this.origin.unicastaddress=matches[6],!0):(Log$6.log("'o=' (Origin) formatted incorrectly: "+line),!1)}_parseSessionName(line){var matches=line.match(/^s=([^\r\n]+)$/);return matches&&matches.length?(this.sessionName=matches[1],!0):(Log$6.log("'s=' (Session Name) formatted incorrectly: "+line),!1)}_parseTiming(line){var matches=line.match(/^t=([0-9]+) ([0-9]+)$/);return matches&&matches.length?(this.timing={},this.timing.start=matches[1],this.timing.stop=matches[2],!0):(Log$6.log("'t=' (Timing) formatted incorrectly: "+line),!1)}_parseMediaDescription(line,media){var fmt,matches=line.match(/^m=([^ ]+) ([^ ]+) ([^ ]+)[ ]/);if(!matches||!matches.length)return Log$6.log("'m=' (Media) formatted incorrectly: "+line),!1;media.type=matches[1],media.port=matches[2],media.proto=matches[3],media.fmt=line.substr(matches[0].length).split(" ").map(function(fmt,index,array){return parseInt(fmt)});for(fmt of media.fmt)this.mediaMap[fmt]=media;return!0}static _parseAttribute(line,media){if(null===media)return!0;var matches,separator=line.indexOf(":");switch(line.substr(0,-1===separator?2147483647:separator)){case"a=recvonly":case"a=sendrecv":case"a=sendonly":case"a=inactive":media.mode=line.substr("a=".length);break;case"a=range":matches=line.match(/^a=range:\s*([a-zA-Z-]+)=([0-9TZtz.]+|now)\s*-\s*([0-9TZtz.]*)$/),media.range=[Number("now"==matches[2]?-1:matches[2]),Number(matches[3]),matches[1]];break;case"a=control":media.control=line.substr("a=control:".length);break;case"a=rtpmap":if(null===(matches=line.match(/^a=rtpmap:(\d+) (.*)$/)))return Log$6.log("Could not parse 'rtpmap' of 'a='"),!1;var payload=parseInt(matches[1]);media.rtpmap[payload]={};var attrs=matches[2].split("/");media.rtpmap[payload].name=attrs[0].toUpperCase(),media.rtpmap[payload].clock=attrs[1],void 0!==attrs[2]&&(media.rtpmap[payload].encparams=attrs[2]),media.ptype=PayloadType.string_map[attrs[0].toUpperCase()];break;case"a=fmtp":if(!(matches=line.match(/^a=fmtp:(\d+) (.*)$/))||0===matches.length)return Log$6.log("Could not parse 'fmtp'  of 'a='"),!1;media.fmtp={};for(var param of matches[2].split(";")){var idx=param.indexOf("=");media.fmtp[param.substr(0,idx).toLowerCase().trim()]=param.substr(idx+1).trim()}}return!0}getSessionBlock(){return this.sessionBlock}hasMedia(mediaType){return null!=this.media[mediaType]}getMediaBlock(mediaType){return this.media[mediaType]}getMediaBlockByPayloadType(pt){return this.mediaMap[pt]||null}getMediaBlockList(){var m,res=[];for(m in this.media)res.push(m);return res}}const Log$7=getTagged("rtsp:stream");class RTSPStream{constructor(client,track){this.state=null,this.client=client,this.track=track,this.rtpChannel=1,this.stopKeepAlive(),this.keepaliveInterval=null,this.keepaliveTime=3e4}reset(){this.stopKeepAlive(),this.client.forgetRTPChannel(this.rtpChannel),this.client=null,this.track=null}start(lastSetupPromise=null){return null!=lastSetupPromise?lastSetupPromise.then(obj=>this.sendSetup(obj.session)):this.sendSetup()}stop(){return this.sendTeardown()}getSetupURL(track){var sessionBlock=this.client.sdp.getSessionBlock();return Url.isAbsolute(track.control)?track.control:Url.isAbsolute(`${sessionBlock.control}${track.control}`)?`${sessionBlock.control}${track.control}`:Url.isAbsolute(`${this.client.contentBase}${track.control}`)?`${this.client.contentBase}${track.control}`:track.control}getControlURL(){var ctrl=this.client.sdp.getSessionBlock().control;return Url.isAbsolute(ctrl)?ctrl:ctrl&&"*"!==ctrl?`${this.client.contentBase}${ctrl}`:this.client.contentBase}sendKeepalive(){return this.client.methods.includes("GET_PARAMETER")?this.client.sendRequest("GET_PARAMETER",this.getSetupURL(this.track),{Session:this.session}):this.client.sendRequest("OPTIONS","*")}stopKeepAlive(){clearInterval(this.keepaliveInterval)}startKeepAlive(){this.keepaliveInterval=setInterval(()=>{this.sendKeepalive().catch(e=>{Log$7.error(e),e instanceof RTSPError&&501==Number(e.data.parsed.code)||this.client.reconnect()})},this.keepaliveTime)}sendRequest(_cmd,_params={}){let params={};return this.session&&(params.Session=this.session),Object.assign(params,_params),this.client.sendRequest(_cmd,this.getControlURL(),params)}sendSetup(session=null){this.state=RTSPClientSM.STATE_SETUP,this.rtpChannel=this.client.interleaveChannelIndex;let params={Transport:`RTP/AVP/TCP;unicast;interleaved=${this.client.interleaveChannelIndex+++"-"+this.client.interleaveChannelIndex++}`,Date:(new Date).toUTCString()};return session&&(params.Session=session),this.client.sendRequest("SETUP",this.getSetupURL(this.track),params).then(_data=>{this.session=_data.headers.session;let transport=_data.headers.transport;var interleaved,chunk;!transport||(interleaved=transport.match(/interleaved=([0-9]+)-([0-9]+)/)[1])&&(this.rtpChannel=Number(interleaved));let sessionParams={};for(chunk of this.session.split(";").slice(1)){var kv=chunk.split("=");sessionParams[kv[0]]=kv[1]}return sessionParams.timeout&&(this.keepaliveInterval=500*Number(sessionParams.timeout)),this.client.useRTPChannel(this.rtpChannel),this.startKeepAlive(),{track:this.track,data:_data,session:this.session}})}}function safeAdd(x,y){var lsw=(65535&x)+(65535&y);return(x>>16)+(y>>16)+(lsw>>16)<<16|65535&lsw}function md5cmn(q,a,b,x,cnt,num){return safeAdd((num=safeAdd(safeAdd(a,q),safeAdd(x,num)))<<(cnt=cnt)|num>>>32-cnt,b)}function md5ff(a,b,c,d,x,s,t){return md5cmn(b&c|~b&d,a,b,x,s,t)}function md5gg(a,b,c,d,x,s,t){return md5cmn(b&d|c&~d,a,b,x,s,t)}function md5hh(a,b,c,d,x,s,t){return md5cmn(b^c^d,a,b,x,s,t)}function md5ii(a,b,c,d,x,s,t){return md5cmn(c^(b|~d),a,b,x,s,t)}function binlMD5(x,len){var olda,oldb,oldc,oldd;x[len>>5]|=128<<len%32,x[14+(len+64>>>9<<4)]=len;for(var a=1732584193,b=-271733879,c=-1732584194,d=271733878,i=0;i<x.length;i+=16)a=md5ff(olda=a,oldb=b,oldc=c,oldd=d,x[i],7,-680876936),d=md5ff(d,a,b,c,x[i+1],12,-389564586),c=md5ff(c,d,a,b,x[i+2],17,606105819),b=md5ff(b,c,d,a,x[i+3],22,-1044525330),a=md5ff(a,b,c,d,x[i+4],7,-176418897),d=md5ff(d,a,b,c,x[i+5],12,1200080426),c=md5ff(c,d,a,b,x[i+6],17,-1473231341),b=md5ff(b,c,d,a,x[i+7],22,-45705983),a=md5ff(a,b,c,d,x[i+8],7,1770035416),d=md5ff(d,a,b,c,x[i+9],12,-1958414417),c=md5ff(c,d,a,b,x[i+10],17,-42063),b=md5ff(b,c,d,a,x[i+11],22,-1990404162),a=md5ff(a,b,c,d,x[i+12],7,1804603682),d=md5ff(d,a,b,c,x[i+13],12,-40341101),c=md5ff(c,d,a,b,x[i+14],17,-1502002290),a=md5gg(a,b=md5ff(b,c,d,a,x[i+15],22,1236535329),c,d,x[i+1],5,-165796510),d=md5gg(d,a,b,c,x[i+6],9,-1069501632),c=md5gg(c,d,a,b,x[i+11],14,643717713),b=md5gg(b,c,d,a,x[i],20,-373897302),a=md5gg(a,b,c,d,x[i+5],5,-701558691),d=md5gg(d,a,b,c,x[i+10],9,38016083),c=md5gg(c,d,a,b,x[i+15],14,-660478335),b=md5gg(b,c,d,a,x[i+4],20,-405537848),a=md5gg(a,b,c,d,x[i+9],5,568446438),d=md5gg(d,a,b,c,x[i+14],9,-1019803690),c=md5gg(c,d,a,b,x[i+3],14,-187363961),b=md5gg(b,c,d,a,x[i+8],20,1163531501),a=md5gg(a,b,c,d,x[i+13],5,-1444681467),d=md5gg(d,a,b,c,x[i+2],9,-51403784),c=md5gg(c,d,a,b,x[i+7],14,1735328473),a=md5hh(a,b=md5gg(b,c,d,a,x[i+12],20,-1926607734),c,d,x[i+5],4,-378558),d=md5hh(d,a,b,c,x[i+8],11,-2022574463),c=md5hh(c,d,a,b,x[i+11],16,1839030562),b=md5hh(b,c,d,a,x[i+14],23,-35309556),a=md5hh(a,b,c,d,x[i+1],4,-1530992060),d=md5hh(d,a,b,c,x[i+4],11,1272893353),c=md5hh(c,d,a,b,x[i+7],16,-155497632),b=md5hh(b,c,d,a,x[i+10],23,-1094730640),a=md5hh(a,b,c,d,x[i+13],4,681279174),d=md5hh(d,a,b,c,x[i],11,-358537222),c=md5hh(c,d,a,b,x[i+3],16,-722521979),b=md5hh(b,c,d,a,x[i+6],23,76029189),a=md5hh(a,b,c,d,x[i+9],4,-640364487),d=md5hh(d,a,b,c,x[i+12],11,-421815835),c=md5hh(c,d,a,b,x[i+15],16,530742520),a=md5ii(a,b=md5hh(b,c,d,a,x[i+2],23,-995338651),c,d,x[i],6,-198630844),d=md5ii(d,a,b,c,x[i+7],10,1126891415),c=md5ii(c,d,a,b,x[i+14],15,-1416354905),b=md5ii(b,c,d,a,x[i+5],21,-57434055),a=md5ii(a,b,c,d,x[i+12],6,1700485571),d=md5ii(d,a,b,c,x[i+3],10,-1894986606),c=md5ii(c,d,a,b,x[i+10],15,-1051523),b=md5ii(b,c,d,a,x[i+1],21,-2054922799),a=md5ii(a,b,c,d,x[i+8],6,1873313359),d=md5ii(d,a,b,c,x[i+15],10,-30611744),c=md5ii(c,d,a,b,x[i+6],15,-1560198380),b=md5ii(b,c,d,a,x[i+13],21,1309151649),a=md5ii(a,b,c,d,x[i+4],6,-145523070),d=md5ii(d,a,b,c,x[i+11],10,-1120210379),c=md5ii(c,d,a,b,x[i+2],15,718787259),b=md5ii(b,c,d,a,x[i+9],21,-343485551),a=safeAdd(a,olda),b=safeAdd(b,oldb),c=safeAdd(c,oldc),d=safeAdd(d,oldd);return[a,b,c,d]}function binl2rstr(input){for(var output="",length32=32*input.length,i=0;i<length32;i+=8)output+=String.fromCharCode(input[i>>5]>>>i%32&255);return output}function rstr2binl(input){var output=[];for(output[(input.length>>2)-1]=void 0,i=0;i<output.length;i+=1)output[i]=0;for(var length8=8*input.length,i=0;i<length8;i+=8)output[i>>5]|=(255&input.charCodeAt(i/8))<<i%32;return output}function rstr2hex(input){for(var x,output="",i=0;i<input.length;i+=1)x=input.charCodeAt(i),output+="0123456789abcdef".charAt(x>>>4&15)+"0123456789abcdef".charAt(15&x);return output}function str2rstrUTF8(input){return unescape(encodeURIComponent(input))}function rawMD5(s){return function(s){return binl2rstr(binlMD5(rstr2binl(s),8*s.length))}(str2rstrUTF8(s))}function rawHMACMD5(k,d){return function(key,hash){var i,bkey=rstr2binl(key),ipad=[],opad=[];for(ipad[15]=opad[15]=void 0,16<bkey.length&&(bkey=binlMD5(bkey,8*key.length)),i=0;i<16;i+=1)ipad[i]=909522486^bkey[i],opad[i]=1549556828^bkey[i];return hash=binlMD5(ipad.concat(rstr2binl(hash)),512+8*hash.length),binl2rstr(binlMD5(opad.concat(hash),640))}(str2rstrUTF8(k),str2rstrUTF8(d))}function md5(string,key,raw){return key?raw?rawHMACMD5(key,string):rstr2hex(rawHMACMD5(key,string)):raw?rawMD5(string):rstr2hex(rawMD5(string))}class RTP{constructor(pkt,sdp){let bytes=new DataView(pkt.buffer,pkt.byteOffset,pkt.byteLength);this.version=bytes.getUint8(0)>>>6,this.padding=1&bytes.getUint8(0),this.has_extension=1&bytes.getUint8(0),this.csrc=15&bytes.getUint8(0),this.marker=bytes.getUint8(1)>>>7,this.pt=127&bytes.getUint8(1),this.sequence=bytes.getUint16(2),this.timestamp=bytes.getUint32(4),this.ssrc=bytes.getUint32(8),this.csrcs=[];let pktIndex=12;0<this.csrc&&(this.csrcs.push(bytes.getUint32(pktIndex)),pktIndex+=4),1==this.has_extension&&(this.extension=bytes.getUint16(pktIndex),this.ehl=bytes.getUint16(pktIndex+2),pktIndex+=4,this.header_data=pkt.slice(pktIndex,this.ehl),pktIndex+=this.ehl),this.headerLength=pktIndex;this.padding&&bytes.getUint8(pkt.byteLength-1),this.media=sdp.getMediaBlockByPayloadType(this.pt),null===this.media?Log.log(`Media description for payload type: ${this.pt} not provided.`):this.type=this.media.ptype,this.data=pkt.subarray(pktIndex)}getPayload(){return this.data}getTimestampMS(){return this.timestamp}toString(){return"RTP(version:"+this.version+", padding:"+this.padding+", has_extension:"+this.has_extension+", csrc:"+this.csrc+", marker:"+this.marker+", pt:"+this.pt+", sequence:"+this.sequence+", timestamp:"+this.timestamp+", ssrc:"+this.ssrc+")"}isVideo(){return"video"==this.media.type}isAudio(){return"audio"==this.media.type}}class RTPFactory{constructor(sdp){for(var pay in this.tsOffsets={},sdp.media)for(var pt of sdp.media[pay].fmt)this.tsOffsets[pt]={last:0,overflow:0}}build(pkt,sdp){let rtp=new RTP(pkt,sdp),tsOffset=this.tsOffsets[rtp.pt];return tsOffset&&(rtp.timestamp+=tsOffset.overflow,tsOffset.last&&2147483647<Math.abs(rtp.timestamp-tsOffset.last)&&(console.log(`\nlast ts: ${tsOffset.last}\n
                            new ts: ${rtp.timestamp}\n
                            new ts adjusted: ${rtp.timestamp+4294967295}\n
                            last overflow: ${tsOffset.overflow}\n
                            new overflow: ${tsOffset.overflow+4294967295}\n
                            `),tsOffset.overflow+=4294967295,rtp.timestamp+=4294967295),tsOffset.last=rtp.timestamp),rtp}}class RTSPMessage{static get RTSP_1_0(){return"RTSP/1.0"}constructor(_rtsp_version){this.version=_rtsp_version}build(_cmd,_host,_params={},_payload=null){let requestString=`${_cmd} ${_host} ${this.version}\r\n`;for(var param in _params)requestString+=`${param}: ${_params[param]}\r\n`;return _payload&&(requestString+=`Content-Length: ${_payload.length}\r\n`),requestString+="\r\n",_payload&&(requestString+=_payload),requestString}parse(_data){let lines=_data.split("\r\n"),parsed={headers:{},body:null,code:0,statusLine:""};var match;[match,parsed.code,parsed.statusLine]=lines[0].match(new RegExp(`${this.version}[ ]+([0-9]{3})[ ]+(.*)`)),parsed.code=Number(parsed.code);let lineIdx=1;for(;lines[lineIdx];){let[k,v]=lines[lineIdx].split(/:(.+)/);parsed.headers[k.toLowerCase()]=v.trim(),lineIdx++}return parsed.body=lines.slice(lineIdx).join("\n\r"),parsed}}const MessageBuilder=new RTSPMessage(RTSPMessage.RTSP_1_0);class NALUAsm{constructor(){this.fragmented_nalu=null}static parseNALHeader(hdr){return{nri:96&hdr,type:31&hdr}}parseSingleNALUPacket(rawData,header,dts,pts){return new NALU(header.type,header.nri,rawData.subarray(0),dts,pts)}parseAggregationPacket(rawData,header,dts,pts){let data=new DataView(rawData.buffer,rawData.byteOffset,rawData.byteLength),nal_start_idx=0;NALU.STAP_B===header.type&&(data.getUint16(nal_start_idx),nal_start_idx+=2);let ret=[];for(;nal_start_idx<data.byteLength;){var size=data.getUint16(nal_start_idx);nal_start_idx+=2;let header=NALUAsm.parseNALHeader(data.getInt8(nal_start_idx));nal_start_idx++;var nalu=this.parseSingleNALUPacket(rawData.subarray(nal_start_idx,nal_start_idx+size),header,dts,pts);null!==nalu&&ret.push(nalu),nal_start_idx+=size}return ret}parseFragmentationUnit(rawData,header,dts,pts){let data=new DataView(rawData.buffer,rawData.byteOffset,rawData.byteLength),nal_start_idx=0;var ret=data.getUint8(nal_start_idx),is_start=(128&ret)>>>7;let is_end=(64&ret)>>>6;var payload_type=31&ret;is_end=is_end&&1,nal_start_idx++;return NALU.FU_B===header.type&&(data.getUint16(nal_start_idx),nal_start_idx+=2),is_start&&(this.fragmented_nalu=new NALU(payload_type,header.nri,rawData.subarray(nal_start_idx),dts,pts)),this.fragmented_nalu&&this.fragmented_nalu.ntype===payload_type&&(is_start||this.fragmented_nalu.appendData(rawData.subarray(nal_start_idx)),is_end)?(ret=this.fragmented_nalu,this.fragmented_nalu=null,ret):null}onNALUFragment(rawData,dts,pts){let data=new DataView(rawData.buffer,rawData.byteOffset,rawData.byteLength);var header=NALUAsm.parseNALHeader(data.getUint8(0));let unit=null;if(0<header.type&&header.type<24)unit=this.parseSingleNALUPacket(rawData.subarray(1),header,dts,pts);else{if(NALU.FU_A!==header.type&&NALU.FU_B!==header.type)return NALU.STAP_A===header.type||NALU.STAP_B===header.type?this.parseAggregationPacket(rawData.subarray(1),header,dts,pts):(Log.log("Undefined NAL unit, type: "+header.type),null);unit=this.parseFragmentationUnit(rawData.subarray(1),header,dts,pts)}return unit?[unit]:null}}class AACFrame{constructor(data,dts,pts){this.dts=dts,this.pts=pts||this.dts,this.data=data}getData(){return this.data}getSize(){return this.data.byteLength}}class AACAsm{constructor(){this.config=null}onAACFragment(pkt){let rawData=pkt.getPayload();if(!pkt.media)return null;let data=new DataView(rawData.buffer,rawData.byteOffset,rawData.byteLength);var sizeLength=Number(pkt.media.fmtp.sizelength||0),indexLength=Number(pkt.media.fmtp.indexlength||0),indexDeltaLength=Number(pkt.media.fmtp.indexdeltalength||0),CTSDeltaLength=Number(pkt.media.fmtp.ctsdeltalength||0),DTSDeltaLength=Number(pkt.media.fmtp.dtsdeltalength||0),RandomAccessIndication=Number(pkt.media.fmtp.randomaccessindication||0),StreamStateIndication=Number(pkt.media.fmtp.streamstateindication||0),configHeaderLength=Number(pkt.media.fmtp.auxiliarydatasizelength||0),configHeaderLength=sizeLength+Math.max(indexLength,indexDeltaLength)+CTSDeltaLength+DTSDeltaLength+RandomAccessIndication+StreamStateIndication+configHeaderLength;let auHeadersLengthPadded=0,offset=0;var ts=9e4*(Math.round(pkt.getTimestampMS()/1024)<<10)/this.config.samplerate;if(0!==configHeaderLength){var auHeadersLengthInBits=data.getUint16(0);auHeadersLengthPadded=2+(auHeadersLengthInBits>>>3)+(7&auHeadersLengthInBits?1:0);let frames=[],frameOffset=7,bits=new BitArray(rawData.subarray(2+offset)),cts=0,dts=0;for(let offset=0;offset<auHeadersLengthInBits;){var size=bits.readBits(sizeLength);bits.readBits(offset?indexDeltaLength:indexLength);offset+=sizeLength+(offset?indexDeltaLength:indexLength),CTSDeltaLength&&(bits.readBits(1),cts=bits.readBits(CTSDeltaLength),offset+=CTSDeltaLength),DTSDeltaLength&&(bits.readBits(1),dts=bits.readBits(DTSDeltaLength),offset+=CTSDeltaLength),RandomAccessIndication&&(bits.skipBits(1),offset+=1),StreamStateIndication&&(bits.skipBits(StreamStateIndication),offset+=StreamStateIndication),frames.push(new AACFrame(rawData.subarray(auHeadersLengthPadded+frameOffset,auHeadersLengthPadded+frameOffset+size),ts+dts,ts+cts)),frameOffset+=size}return frames}for(var aacData=rawData.subarray(auHeadersLengthPadded);255==aacData[offset];)++offset;return++offset,[new AACFrame(rawData.subarray(auHeadersLengthPadded+offset),ts)]}}class RTPPayloadParser{constructor(){this.h264parser=new RTPH264Parser,this.aacparser=new RTPAACParser}parse(rtp){return"video"==rtp.media.type?this.h264parser.parse(rtp):"audio"==rtp.media.type?this.aacparser.parse(rtp):null}}class RTPH264Parser{constructor(){this.naluasm=new NALUAsm}parse(rtp){return this.naluasm.onNALUFragment(rtp.getPayload(),rtp.getTimestampMS())}}class RTPAACParser{constructor(){this.scale=1,this.asm=new AACAsm}setConfig(conf){this.asm.config=conf}parse(rtp){return this.asm.onAACFragment(rtp)}}class AACParser{static get SampleRates(){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]}static parseAudioSpecificConfig(channels){let config;config=channels.byteLength?new BitArray(channels):channels;var bitpos=config.bitpos+8*(config.src.byteOffset+config.bytepos),prof=config.readBits(5);this.codec=`mp4a.40.${prof}`;var sfi=config.readBits(4);15==sfi&&config.skipBits(24);channels=config.readBits(4);return{config:function(bytearray,start,end){var byteLen=Math.ceil((end-start)/8);let res=new Uint8Array(byteLen);var startByte=start>>>3,endByte=(end>>>3)-1,bitOffset=7&start,nBitOffset=8-bitOffset,endOffset=8-end&7;for(let i=0;i<byteLen;++i){let tail=0;i<endByte&&(tail=bytearray[startByte+i+1]>>nBitOffset,i==endByte-1&&endOffset<8&&(tail>>=endOffset,tail<<=endOffset)),res[i]=bytearray[startByte+i]<<bitOffset|tail}return res}(new Uint8Array(config.src.buffer),bitpos,bitpos+16),codec:`mp4a.40.${prof}`,samplerate:AACParser.SampleRates[sfi],channels:channels}}static parseStreamMuxConfig(bytes){let config=new BitArray(bytes);if(!config.readBits(1))return config.skipBits(14),AACParser.parseAudioSpecificConfig(config)}}const Log$8=getTagged("rtsp:session");class RTSPSession{constructor(client,sessionId){this.state=null,this.client=client,this.sessionId=sessionId,this.url=this.getControlURL()}reset(){this.client=null}start(){return this.sendPlay()}stop(){return this.sendTeardown()}getControlURL(){var ctrl=this.client.sdp.getSessionBlock().control;return Url.isAbsolute(ctrl)?ctrl:ctrl&&"*"!==ctrl?`${this.client.contentBase}${ctrl}`:this.client.contentBase}sendRequest(_cmd,_params={}){let params={};return this.sessionId&&(params.Session=this.sessionId),Object.assign(params,_params),this.client.sendRequest(_cmd,this.getControlURL(),params)}async sendPlay(pos=0){this.state=RTSPClientSM.STATE_PLAY;let range=this.client.sdp.sessionBlock.range;range&&-1==range[0]&&(range[0]=0);var data=await this.sendRequest("PLAY",{});return this.state=RTSPClientSM.STATE_PLAYING,{data:data}}async sendPause(){this.client.supports("PAUSE")&&(this.state=RTSPClientSM.STATE_PAUSE,await this.sendRequest("PAUSE"),this.state=RTSPClientSM.STATE_PAUSED)}async sendTeardown(){this.state!=RTSPClientSM.STATE_TEARDOWN&&(this.state=RTSPClientSM.STATE_TEARDOWN,await this.sendRequest("TEARDOWN"),Log$8.log("RTSPClient: STATE_TEARDOWN"))}}const Log$9=getTagged("client:rtsp");class RTSPClient extends class{constructor(options={flush:100}){this.options=options,this.eventSource=new EventEmitter,Object.defineProperties(this,{sourceUrl:{value:null,writable:!0},paused:{value:!0,writable:!0},seekable:{value:!1,writable:!0},connected:{value:!1,writable:!0}}),this._onData=()=>{if(this.connected)for(;this.transport.dataQueue.length;)this.onData(this.transport.dataQueue.pop())},this._onConnect=this.onConnected.bind(this),this._onDisconnect=this.onDisconnected.bind(this)}static streamType(){return null}destroy(){this.detachTransport()}attachTransport(transport){this.transport&&this.detachTransport(),this.transport=transport,this.transport.eventSource.addEventListener("data",this._onData),this.transport.eventSource.addEventListener("connected",this._onConnect),this.transport.eventSource.addEventListener("disconnected",this._onDisconnect)}detachTransport(){this.transport&&(this.transport.eventSource.removeEventListener("data",this._onData),this.transport.eventSource.removeEventListener("connected",this._onConnect),this.transport.eventSource.removeEventListener("disconnected",this._onDisconnect),this.transport=null)}reset(){}start(){Log.log("Client started"),this.paused=!1}stop(){Log.log("Client paused"),this.paused=!0}seek(timeOffset){}setSource(source){this.stop(),this.endpoint=source,this.sourceUrl=source.urlpath}startStreamFlush(){this.flushInterval=setInterval(()=>{this.paused||this.eventSource.dispatchEvent("flush")},this.options.flush)}stopStreamFlush(){clearInterval(this.flushInterval)}onData(data){}onConnected(){this.seekable||(this.transport.dataQueue=[],this.eventSource.dispatchEvent("clear")),this.connected=!0}onDisconnected(){this.connected=!1}queryCredentials(){return Promise.resolve()}setCredentials(user,password){this.endpoint.user=user,this.endpoint.pass=password,this.endpoint.auth=`${user}:${password}`}}{constructor(options={flush:200}){super(options),this.clientSM=new RTSPClientSM(this),this.clientSM.ontracks=tracks=>{this.eventSource.dispatchEvent("tracks",tracks),this.startStreamFlush()},this.sampleQueues={}}static streamType(){return"rtsp"}setSource(url){super.setSource(url),this.clientSM.setSource(url)}attachTransport(transport){super.attachTransport(transport),this.clientSM.transport=transport}detachTransport(){super.detachTransport(),this.clientSM.transport=null}reset(){super.reset(),this.sampleQueues={}}destroy(){return this.clientSM.destroy(),super.destroy()}start(){return super.start(),this.transport?this.transport.ready.then(()=>this.clientSM.start()):Promise.reject("no transport attached")}stop(){return super.stop(),this.clientSM.stop()}onData(data){this.clientSM.onData(data)}onConnected(){this.clientSM.onConnected(),super.onConnected()}onDisconnected(){super.onDisconnected(),this.clientSM.onDisconnected()}}class AuthError extends Error{constructor(msg){super(msg)}}class RTSPError extends Error{constructor(data){super(data.msg),this.data=data}}class RTSPClientSM extends class{constructor(){this.storage={},this.currentState=null,this.states=new Map}addState(name,{activate,finishTransition,deactivate}){let state=new State(name,this);return activate&&(state.activate=activate),finishTransition&&(state.finishTransition=finishTransition),deactivate&&(state.deactivate=deactivate),this.states.set(name,state),this}addTransition(fromName,toName){if(!this.states.has(fromName))throw ReferenceError(`No such state: ${fromName} while connecting to ${toName}`);if(!this.states.has(toName))throw ReferenceError(`No such state: ${toName} while connecting from ${fromName}`);return this.states.get(fromName).transitions.add(toName),this}_promisify(res){let promise;try{promise=res,promise.then||(promise=Promise.resolve(promise))}catch(e){promise=Promise.reject(e)}return promise}transitionTo(stateName){if(null==this.currentState){let state=this.states.get(stateName);return this._promisify(state.activate.call(this)).then(data=>(this.currentState=state,data)).then(state.finishTransition.bind(this)).catch(e=>{throw state.failHandler(),e})}if(this.currentState.name==stateName)return Promise.resolve();if(this.currentState.transitions.has(stateName)){let state=this.states.get(stateName);return this._promisify(state.deactivate.call(this)).then(state.activate.bind(this)).then(data=>(this.currentState=state,data)).then(state.finishTransition.bind(this)).catch(e=>{throw state.failHandler(),e})}return Promise.reject(`No such transition: ${this.currentState.name} to ${stateName}`)}}{static get USER_AGENT(){return"SFRtsp 0.3"}static get STATE_INITIAL(){return 1}static get STATE_OPTIONS(){return 2}static get STATE_DESCRIBE(){return 4}static get STATE_SETUP(){return 8}static get STATE_STREAMS(){return 16}static get STATE_TEARDOWN(){return 32}static get STATE_PLAY(){return 64}static get STATE_PLAYING(){return 128}static get STATE_PAUSE(){return 256}static get STATE_PAUSED(){return 512}constructor(parent){super(),this.parent=parent,this.transport=null,this.payParser=new RTPPayloadParser,this.rtp_channels=new Set,this.sessions={},this.ontracks=null,this.stream=null,this.addState(RTSPClientSM.STATE_INITIAL,{}).addState(RTSPClientSM.STATE_OPTIONS,{activate:this.sendOptions,finishTransition:this.onOptions}).addState(RTSPClientSM.STATE_DESCRIBE,{activate:this.sendDescribe,finishTransition:this.onDescribe}).addState(RTSPClientSM.STATE_SETUP,{activate:this.sendSetup,finishTransition:this.onSetup}).addState(RTSPClientSM.STATE_STREAMS,{}).addState(RTSPClientSM.STATE_TEARDOWN,{activate:()=>{this.started=!1},finishTransition:()=>this.transitionTo(RTSPClientSM.STATE_INITIAL)}).addTransition(RTSPClientSM.STATE_INITIAL,RTSPClientSM.STATE_OPTIONS).addTransition(RTSPClientSM.STATE_INITIAL,RTSPClientSM.STATE_TEARDOWN).addTransition(RTSPClientSM.STATE_OPTIONS,RTSPClientSM.STATE_DESCRIBE).addTransition(RTSPClientSM.STATE_DESCRIBE,RTSPClientSM.STATE_SETUP).addTransition(RTSPClientSM.STATE_SETUP,RTSPClientSM.STATE_STREAMS).addTransition(RTSPClientSM.STATE_TEARDOWN,RTSPClientSM.STATE_INITIAL).addTransition(RTSPClientSM.STATE_STREAMS,RTSPClientSM.STATE_TEARDOWN).addTransition(RTSPClientSM.STATE_SETUP,RTSPClientSM.STATE_TEARDOWN).addTransition(RTSPClientSM.STATE_DESCRIBE,RTSPClientSM.STATE_TEARDOWN).addTransition(RTSPClientSM.STATE_OPTIONS,RTSPClientSM.STATE_TEARDOWN),this.reset(),this.shouldReconnect=!1}destroy(){this.parent=null}setSource(url){this.reset(),this.endpoint=url,this.url=`${url.protocol}://${url.location}${url.urlpath}`}onConnected(){this.rtpFactory&&(this.rtpFactory=null),this.shouldReconnect&&this.start()}async onDisconnected(){this.reset(),this.shouldReconnect=!0,await this.transitionTo(RTSPClientSM.STATE_TEARDOWN),await this.transitionTo(RTSPClientSM.STATE_INITIAL)}start(){if(this.currentState.name!==RTSPClientSM.STATE_STREAMS)return this.transitionTo(RTSPClientSM.STATE_OPTIONS);{let promises=[];for(var session in this.sessions)promises.push(this.sessions[session].sendPlay());return Promise.all(promises)}}onData(data){var channel=data[1];data[2],data[3];this.rtp_channels.has(channel)?this.onRTP({packet:data.subarray(4),type:channel}):console.log("onData: failed")}useRTPChannel(channel){this.rtp_channels.add(channel)}forgetRTPChannel(channel){this.rtp_channels.delete(channel)}stop(){this.shouldReconnect=!1;let promises=[];for(var session in this.sessions)promises.push(this.sessions[session].sendPause());return Promise.all(promises)}async reset(){for(var stream in this.authenticator="",this.methods=[],this.tracks=[],this.rtpBuffer={},this.streams)this.streams[stream].reset();for(var session in this.sessions)this.sessions[session].reset();this.streams={},this.sessions={},this.contentBase="",this.currentState?this.currentState.name!=RTSPClientSM.STATE_INITIAL&&(await this.transitionTo(RTSPClientSM.STATE_TEARDOWN),await this.transitionTo(RTSPClientSM.STATE_INITIAL)):await this.transitionTo(RTSPClientSM.STATE_INITIAL),this.sdp=null,this.interleaveChannelIndex=0,this.session=null,this.timeOffset={},this.lastTimestamp={}}async reconnect(){return await this.reset(),this.currentState.name!=RTSPClientSM.STATE_INITIAL&&await this.transitionTo(RTSPClientSM.STATE_TEARDOWN),this.transitionTo(RTSPClientSM.STATE_OPTIONS)}supports(method){return this.methods.includes(method)}parse(_data){Log$9.debug(_data.payload);var d=_data.payload.split("\r\n\r\n");let parsed=MessageBuilder.parse(d[0]);if(Number(parsed.headers["content-length"])){let d=_data.payload.split("\r\n\r\n");parsed.body=d[1]}else parsed.body="";return parsed}sendRequest(_cmd,_host,_params={},_payload=null){return this.cSeq++,Object.assign(_params,{CSeq:this.cSeq,"User-Agent":RTSPClientSM.USER_AGENT}),this.authenticator&&this.parent&&(_params.Authorization=this.authenticator(_cmd)),this.send(MessageBuilder.build(_cmd,_host,_params,_payload),_cmd).catch(e=>{if(e instanceof AuthError&&!_params.Authorization)return this.sendRequest(_cmd,_host,_params,_payload);throw e})}async send(chunks,_method){if(this.transport){try{await this.transport.ready}catch(e){throw this.onDisconnected(),e}Log$9.debug(chunks);var ep=await this.transport.send(chunks),parsed=this.parse(ep);if(401!=parsed.code)return 300<=parsed.code&&(Log$9.error(parsed.statusLine),this.parent.options.errorHandler(new RTSPError({msg:`RTSP error: ${parsed.code} ${parsed.statusLine}`,parsed:parsed}))),parsed;{Log$9.debug(parsed.headers["www-authenticate"]);let auth=parsed.headers["www-authenticate"],method=auth.substring(0,auth.indexOf(" "));auth=auth.substr(method.length+1);chunks=auth.split(","),ep=this.parent.endpoint;if(!ep.user||!ep.pass)try{await this.parent.queryCredentials.call(this.parent)}catch(e){throw new AuthError}if("digest"==method.toLowerCase()){let parsedChunks={};for(var chunk of chunks){let c=chunk.trim(),[k,v]=c.split("=");parsedChunks[k]=v.substr(1,v.length-2)}this.authenticator=response=>{var ep=this.parent.endpoint,ha1=md5(`${ep.user}:${parsedChunks.realm}:${ep.pass}`),response=md5(`${response}:${this.url}`),response=md5(`${ha1}:${parsedChunks.nonce}:${response}`);return`Digest username="${ep.user}", realm="${parsedChunks.realm}", nonce="${parsedChunks.nonce}", uri="${this.url}", response="${response}"`}}else this.authenticator=()=>`Basic ${btoa(this.parent.endpoint.auth)}`;throw new AuthError(parsed)}}return Promise.reject("No transport attached")}sendOptions(){return this.reset(),this.started=!0,this.cSeq=0,this.sendRequest("OPTIONS",this.url,{})}onOptions(data){this.methods=data.headers.public.split(",").map(e=>e.trim()),this.transitionTo(RTSPClientSM.STATE_DESCRIBE)}sendDescribe(){return this.sendRequest("DESCRIBE",this.url,{Accept:"application/sdp"}).then(data=>(this.sdp=new SDPParser,this.sdp.parse(data.body).catch(()=>{throw new Error("Failed to parse SDP")}).then(()=>data)))}onDescribe(data){if(this.contentBase=data.headers["content-base"]||this.url,this.tracks=this.sdp.getMediaBlockList(),this.rtpFactory=new RTPFactory(this.sdp),Log$9.log("SDP contained "+this.tracks.length+" track(s). Calling SETUP for each."),data.headers.session&&(this.session=data.headers.session),!this.tracks.length)throw new Error("No tracks in SDP");this.transitionTo(RTSPClientSM.STATE_SETUP)}sendSetup(){let streams=[],lastPromise=null;for(var track_type of this.tracks){Log$9.log("setup track: "+track_type);var track=this.sdp.getMediaBlock(track_type);if(PayloadType.string_map[track.rtpmap[track.fmt[0]].name]&&("audio"!=track_type||0!=track.fmtp.config)){this.streams[track_type]=new RTSPStream(this,track);let setupPromise=this.streams[track_type].start(lastPromise);lastPromise=setupPromise,this.parent.sampleQueues[PayloadType.string_map[track.rtpmap[track.fmt[0]].name]]=[],this.rtpBuffer[track.fmt[0]]=[],streams.push(setupPromise.then(({track,data:session})=>{this.timeOffset[track.fmt[0]]=0;try{var chunk;for(chunk of session.headers["rtp-info"].split(";")){var[key]=chunk.split("=");"rtptime"===key&&(this.timeOffset[track.fmt[0]]=0)}}catch(e){}let params={timescale:0,scaleFactor:0};var sps_pps;track.fmtp["sprop-parameter-sets"]?(sps_pps=track.fmtp["sprop-parameter-sets"].split(","),params={sps:base64ToArrayBuffer(sps_pps[0]),pps:base64ToArrayBuffer(sps_pps[1])}):track.fmtp.config&&(res=track.fmtp.config,this.has_config="0"!=track.fmtp.cpresent,"MPEG4-GENERIC"==track.rtpmap[track.fmt[0]].name?(params={config:AACParser.parseAudioSpecificConfig(hexToByteArray(res))},this.payParser.aacparser.setConfig(params.config)):res&&(params={config:AACParser.parseStreamMuxConfig(hexToByteArray(res))},this.payParser.aacparser.setConfig(params.config))),params.duration=this.sdp.sessionBlock.range?this.sdp.sessionBlock.range[1]-this.sdp.sessionBlock.range[0]:1,this.parent.seekable=1<params.duration;var res={track:track,offset:this.timeOffset[track.fmt[0]],type:PayloadType.string_map[track.rtpmap[track.fmt[0]].name],params:params,duration:params.duration};console.log(res,this.timeOffset);session=session.headers.session.split(";")[0];return this.sessions[session]||(this.sessions[session]=new RTSPSession(this,session)),res}))}}return Promise.all(streams).then(tracks=>{let sessionPromises=[];for(var session in this.sessions)sessionPromises.push(this.sessions[session].start());return Promise.all(sessionPromises).then(()=>{this.ontracks&&this.ontracks(tracks)})}).catch(e=>{console.error(e),this.stop(),this.reset()})}onSetup(){this.transitionTo(RTSPClientSM.STATE_STREAMS)}onRTP(rtp){if(this.rtpFactory){var pay,rtp=this.rtpFactory.build(rtp.packet,this.sdp);if(rtp.type)if(void 0!==this.timeOffset[rtp.pt]){void 0===this.lastTimestamp[rtp.pt]&&(this.lastTimestamp[rtp.pt]=rtp.timestamp-this.timeOffset[rtp.pt]);let queue=this.rtpBuffer[rtp.pt];for(queue.push(rtp);queue.length;){let rtp=queue.shift();rtp.timestamp=rtp.timestamp-this.timeOffset[rtp.pt]-this.lastTimestamp[rtp.pt],!rtp.media||(pay=this.payParser.parse(rtp))&&this.parent.sampleQueues[rtp.type].push(pay)}}else this.rtpBuffer[rtp.pt].push(rtp)}}}var DOM_tag=function(t,className){t=document.createElement(t);return t.className=className,t},DOM_text=function(str){return document.createTextNode(str)};class Stream{static get hexDigits(){return"0123456789ABCDEF"}static get reTime(){return/^((?:1[89]|2\d)?\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/}constructor(enc,pos){enc instanceof Stream?(this.enc=enc.enc,this.pos=enc.pos):(this.enc=enc,this.pos=pos)}get(pos){if((pos=void 0===pos?this.pos++:pos)>=this.enc.length)throw"Requesting byte offset "+pos+" on a stream of length "+this.enc.length;return this.enc[pos]}hexByte(b){return Stream.hexDigits.charAt(b>>4&15)+Stream.hexDigits.charAt(15&b)}hexDump(start,end,raw){for(var s="",i=start;i<end;++i)if(s+=this.hexByte(this.get(i)),!0!==raw)switch(15&i){case 7:s+="  ";break;case 15:s+="\n";break;default:s+=" "}return s}parseStringISO(start,end){for(var s="",i=start;i<end;++i)s+=String.fromCharCode(this.get(i));return s}parseStringUTF(start,end){for(var s="",i=start;i<end;){var c=this.get(i++);s+=c<128?String.fromCharCode(c):191<c&&c<224?String.fromCharCode((31&c)<<6|63&this.get(i++)):String.fromCharCode((15&c)<<12|(63&this.get(i++))<<6|63&this.get(i++))}return s}parseStringBMP(start,end){for(var str="",i=start;i<end;i+=2){var high_byte=this.get(i),low_byte=this.get(i+1);str+=String.fromCharCode((high_byte<<8)+low_byte)}return str}parseTime(s,m){s=this.parseStringISO(s,m),m=Stream.reTime.exec(s);return m?(s=m[1]+"-"+m[2]+"-"+m[3]+" "+m[4],m[5]&&(s+=":"+m[5],m[6]&&(s+=":"+m[6],m[7]&&(s+="."+m[7]))),m[8]&&(s+=" UTC","Z"!=m[8]&&(s+=m[8],m[9]&&(s+=":"+m[9]))),s):"Unrecognized time: "+s}parseInteger(start,end){var len=end-start;if(4<len){len<<=3;var s=this.get(start);if(0===s)len-=8;else for(;s<128;)s<<=1,--len;return"("+len+" bit)"}for(var n=0,i=start;i<end;++i)n=n<<8|this.get(i);return n}parseBitString(start,end){var unusedBit=this.get(start),lenBit=(end-start-1<<3)-unusedBit,s="("+lenBit+" bit)";if(lenBit<=20){var skip=unusedBit;s+=" ";for(var i=end-1;start<i;--i){for(var b=this.get(i),j=skip;j<8;++j)s+=b>>j&1?"1":"0";skip=0}}return s}parseOctetString(start,end){var len=end-start,s="("+len+" byte) ";100<len&&(end=start+100);for(var i=start;i<end;++i)s+=this.hexByte(this.get(i));return 100<len&&(s+="…"),s}parseOID(start,end){for(var s="",n=0,bits=0,i=start;i<end;++i){var m=this.get(i),n=n<<7|127&m;bits+=7,128&m||(""===s?s=(m=n<80?n<40?0:1:2)+"."+(n-40*m):s+="."+(31<=bits?"bigint":n),n=bits=0)}return s}}class ASN1{static get reSeemsASCII(){return/^[ -~]+$/}constructor(stream,header,length,tag,sub){this.stream=stream,this.header=header,this.length=length,this.tag=tag,this.sub=sub}typeName(){if(void 0===this.tag)return"unknown";var tagClass=this.tag>>6,tagNumber=(this.tag,31&this.tag);switch(tagClass){case 0:switch(tagNumber){case 0:return"EOC";case 1:return"BOOLEAN";case 2:return"INTEGER";case 3:return"BIT_STRING";case 4:return"OCTET_STRING";case 5:return"NULL";case 6:return"OBJECT_IDENTIFIER";case 7:return"ObjectDescriptor";case 8:return"EXTERNAL";case 9:return"REAL";case 10:return"ENUMERATED";case 11:return"EMBEDDED_PDV";case 12:return"UTF8String";case 16:return"SEQUENCE";case 17:return"SET";case 18:return"NumericString";case 19:return"PrintableString";case 20:return"TeletexString";case 21:return"VideotexString";case 22:return"IA5String";case 23:return"UTCTime";case 24:return"GeneralizedTime";case 25:return"GraphicString";case 26:return"VisibleString";case 27:return"GeneralString";case 28:return"UniversalString";case 30:return"BMPString";default:return"Universal_"+tagNumber.toString(16)}case 1:return"Application_"+tagNumber.toString(16);case 2:return"["+tagNumber+"]";case 3:return"Private_"+tagNumber.toString(16)}}content(){if(void 0===this.tag)return null;var s=this.tag>>6,tagNumber=31&this.tag,content=this.posContent(),len=Math.abs(this.length);if(0!=s){if(null!==this.sub)return"("+this.sub.length+" elem)";s=this.stream.parseStringISO(content,content+Math.min(len,100));return ASN1.reSeemsASCII.test(s)?s.substring(0,200)+(200<s.length?"…":""):this.stream.parseOctetString(content,content+len)}switch(tagNumber){case 1:return 0===this.stream.get(content)?"false":"true";case 2:return this.stream.parseInteger(content,content+len);case 3:return this.sub?"("+this.sub.length+" elem)":this.stream.parseBitString(content,content+len);case 4:return this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(content,content+len);case 6:return this.stream.parseOID(content,content+len);case 16:case 17:return"("+this.sub.length+" elem)";case 12:return this.stream.parseStringUTF(content,content+len);case 18:case 19:case 20:case 21:case 22:case 26:return this.stream.parseStringISO(content,content+len);case 30:return this.stream.parseStringBMP(content,content+len);case 23:case 24:return this.stream.parseTime(content,content+len)}return null}toString(){return this.typeName()+"@"+this.stream.pos+"[header:"+this.header+",length:"+this.length+",sub:"+(null===this.sub?"null":this.sub.length)+"]"}print(indent){if(void 0===indent&&(indent=""),document.writeln(indent+this),null!==this.sub){indent+="  ";for(var i=0,max=this.sub.length;i<max;++i)this.sub[i].print(indent)}}toPrettyString(indent){var s=(indent=void 0===indent?"":indent)+this.typeName()+" @"+this.stream.pos;if(0<=this.length&&(s+="+"),s+=this.length,32&this.tag?s+=" (constructed)":3!=this.tag&&4!=this.tag||null===this.sub||(s+=" (encapsulates)"),s+="\n",null!==this.sub){indent+="  ";for(var i=0,max=this.sub.length;i<max;++i)s+=this.sub[i].toPrettyString(indent)}return s}toDOM(){var node=DOM_tag("div","node");node.asn1=this;var head=DOM_tag("div","head"),s=this.typeName().replace(/_/g," ");head.innerHTML=s;var oid=this.content();null!==oid&&(oid=String(oid).replace(/</g,"&lt;"),(value=DOM_tag("span","preview")).appendChild(DOM_text(oid)),head.appendChild(value)),node.appendChild(head),this.node=node,this.head=head;var value=DOM_tag("div","value"),s="Offset: "+this.stream.pos+"<br/>";s+="Length: "+this.header+"+",0<=this.length?s+=this.length:s+=-this.length+" (undefined)",32&this.tag?s+="<br/>(constructed)":3!=this.tag&&4!=this.tag||null===this.sub||(s+="<br/>(encapsulates)"),null!==oid&&(s+="<br/>Value:<br/><b>"+oid+"</b>","object"!=typeof oids||6!=this.tag||(oid=oids[oid])&&(oid.d&&(s+="<br/>"+oid.d),oid.c&&(s+="<br/>"+oid.c),oid.w&&(s+="<br/>(warning!)"))),value.innerHTML=s,node.appendChild(value);var sub=DOM_tag("div","sub");if(null!==this.sub)for(var i=0,max=this.sub.length;i<max;++i)sub.appendChild(this.sub[i].toDOM());return node.appendChild(sub),head.onclick=function(){node.className="node collapsed"==node.className?"node":"node collapsed"},node}posStart(){return this.stream.pos}posContent(){return this.stream.pos+this.header}posEnd(){return this.stream.pos+this.header+Math.abs(this.length)}fakeHover(current){this.node.className+=" hover",current&&(this.head.className+=" hover")}fakeOut(current){var re=/ ?hover/;this.node.className=this.node.className.replace(re,""),current&&(this.head.className=this.head.className.replace(re,""))}toHexDOM_sub(node,sub,stream,start,end){end<=start||((sub=DOM_tag("span",sub)).appendChild(DOM_text(stream.hexDump(start,end))),node.appendChild(sub))}toHexDOM(root){var node=DOM_tag("span","hex");if(void 0===root&&(root=node),this.head.hexNode=node,this.head.onmouseover=function(){this.hexNode.className="hexCurrent"},this.head.onmouseout=function(){this.hexNode.className="hex"},node.asn1=this,node.onmouseover=function(){var current=!root.selected;current&&(root.selected=this.asn1,this.className="hexCurrent"),this.asn1.fakeHover(current)},node.onmouseout=function(){var current=root.selected==this.asn1;this.asn1.fakeOut(current),current&&(root.selected=null,this.className="hex")},this.toHexDOM_sub(node,"tag",this.stream,this.posStart(),this.posStart()+1),this.toHexDOM_sub(node,0<=this.length?"dlen":"ulen",this.stream,this.posStart()+1,this.posContent()),null===this.sub)node.appendChild(DOM_text(this.stream.hexDump(this.posContent(),this.posEnd())));else if(0<this.sub.length){var first=this.sub[0],last=this.sub[this.sub.length-1];this.toHexDOM_sub(node,"intro",this.stream,this.posContent(),first.posStart());for(var i=0,max=this.sub.length;i<max;++i)node.appendChild(this.sub[i].toHexDOM(root));this.toHexDOM_sub(node,"outro",this.stream,last.posEnd(),this.posEnd())}return node}toHexString(root){return this.stream.hexDump(this.posStart(),this.posEnd(),!0)}}ASN1.decodeLength=function(stream){var len=127&(buf=stream.get());if(len==buf)return len;if(3<len)throw"Length over 24 bits not supported at position "+(stream.pos-1);if(0==len)return-1;for(var buf=0,i=0;i<len;++i)buf=buf<<8|stream.get();return buf},ASN1.hasContent=function(tag,len,stream){if(32&tag)return!0;if(tag<3||4<tag)return!1;var p=new Stream(stream);if(3==tag&&p.get(),p.get()>>6&1)return!1;try{var subLength=ASN1.decodeLength(p);return p.pos-stream.pos+subLength==len}catch(exception){return!1}},ASN1.decode=function(stream){stream instanceof Stream||(stream=new Stream(stream,0));var streamStart=new Stream(stream),tag=stream.get(),len=ASN1.decodeLength(stream),header=stream.pos-streamStart.pos,sub=null;if(ASN1.hasContent(tag,len,stream)){var start=stream.pos;if(3==tag&&stream.get(),sub=[],0<=len){for(var end=start+len;stream.pos<end;)sub[sub.length]=ASN1.decode(stream);if(stream.pos!=end)throw"Content size is not correct for container starting at offset "+start}else try{for(;;){var s=ASN1.decode(stream);if(0===s.tag)break;sub[sub.length]=s}len=start-stream.pos}catch(e){throw"Exception while decoding undefined length content: "+e}}else stream.pos+=len;return new ASN1(streamStart,header,len,tag,sub)},ASN1.test=function(){for(var test=[{value:[39],expected:39},{value:[129,201],expected:201},{value:[131,254,220,186],expected:16702650}],i=0,max=test.length;i<max;++i){var res=new Stream(test[i].value,0),res=ASN1.decodeLength(res);res!=test[i].expected&&document.write("In test["+i+"] expected "+test[i].expected+" got "+res+"\n")}};class Arcfour{constructor(){this.i=0,this.j=0,this.S=[]}}Arcfour.prototype.init=function(key){for(var j,t,i=0;i<256;++i)this.S[i]=i;for(i=j=0;i<256;++i)j=j+this.S[i]+key[i%key.length]&255,t=this.S[i],this.S[i]=this.S[j],this.S[j]=t;this.i=0,this.j=0},Arcfour.prototype.next=function(){var t;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,t=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=t,this.S[t+this.S[this.i]&255]};var rng_state,dbits,rng_psize=256;if(null==rng_pool){var t,rng_pool=new Array,rng_pptr=0;if(window.crypto&&window.crypto.getRandomValues){var z=new Uint32Array(256);for(window.crypto.getRandomValues(z),t=0;t<z.length;++t)rng_pool[rng_pptr++]=255&z[t]}var onMouseMoveListener=function(ev){if(this.count=this.count||0,256<=this.count||rng_psize<=rng_pptr)window.removeEventListener?window.removeEventListener("mousemove",onMouseMoveListener,!1):window.detachEvent&&window.detachEvent("onmousemove",onMouseMoveListener);else try{var mouseCoordinates=ev.x+ev.y;rng_pool[rng_pptr++]=255&mouseCoordinates,this.count+=1}catch(e){}};window.addEventListener?window.addEventListener("mousemove",onMouseMoveListener,!1):window.attachEvent&&window.attachEvent("onmousemove",onMouseMoveListener)}function rng_get_byte(){if(null==rng_state){for(rng_state=new Arcfour;rng_pptr<rng_psize;){var random=Math.floor(65536*Math.random());rng_pool[rng_pptr++]=255&random}for(rng_state.init(rng_pool),rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}return rng_state.next()}class SecureRandom{constructor(){}}SecureRandom.prototype.nextBytes=function(ba){for(var i=0;i<ba.length;++i)ba[i]=rng_get_byte()};class BigInteger{constructor(a,b,c){null!=a&&("number"==typeof a?this.fromNumber(a,b,c):null==b&&"string"!=typeof a?this.fromString(a,256):this.fromString(a,b))}}function nbi(){return new BigInteger(null)}dbits="Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=function(i,x,w,j,c,n){for(var xl=32767&x,xh=x>>15;0<=--n;){var l=32767&this[i],h=this[i++]>>15,m=xh*l+h*xl;c=((l=xl*l+((32767&m)<<15)+w[j]+(1073741823&c))>>>30)+(m>>>15)+xh*h+(c>>>30),w[j++]=1073741823&l}return c},30):"Netscape"!=navigator.appName?(BigInteger.prototype.am=function(i,x,w,j,c,n){for(;0<=--n;){var v=x*this[i++]+w[j]+c;c=Math.floor(v/67108864),w[j++]=67108863&v}return c},26):(BigInteger.prototype.am=function(i,x,w,j,c,n){for(var xl=16383&x,xh=x>>14;0<=--n;){var l=16383&this[i],h=this[i++]>>14,m=xh*l+h*xl;c=((l=xl*l+((16383&m)<<14)+w[j]+c)>>28)+(m>>14)+xh*h,w[j++]=268435455&l}return c},28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;BigInteger.prototype.FV=Math.pow(2,52),BigInteger.prototype.F1=52-dbits,BigInteger.prototype.F2=2*dbits-52;for(var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=[],rr="0".charCodeAt(0),vv=0;vv<=9;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;function int2char(n){return BI_RM.charAt(n)}function intAt(s,c){c=BI_RC[s.charCodeAt(c)];return null==c?-1:c}function nbv(i){var r=nbi();return r.fromInt(i),r}function nbits(x){var t,r=1;return 0!=(t=x>>>16)&&(x=t,r+=16),0!=(t=x>>8)&&(x=t,r+=8),0!=(t=x>>4)&&(x=t,r+=4),0!=(t=x>>2)&&(x=t,r+=2),0!=(t=x>>1)&&(x=t,r+=1),r}class Classic{constructor(m){this.m=m}}Classic.prototype.convert=function(x){return x.s<0||0<=x.compareTo(this.m)?x.mod(this.m):x},Classic.prototype.revert=function(x){return x},Classic.prototype.reduce=function(x){x.divRemTo(this.m,null,x)},Classic.prototype.mulTo=function(x,y,r){x.multiplyTo(y,r),this.reduce(r)},Classic.prototype.sqrTo=function(x,r){x.squareTo(r),this.reduce(r)};class Montgomery{constructor(m){this.m=m,this.mp=m.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<m.DB-15)-1,this.mt2=2*m.t}}function op_and(x,y){return x&y}function op_or(x,y){return x|y}function op_xor(x,y){return x^y}function op_andnot(x,y){return x&~y}function NullExp(){}function nNop(x){return x}function Barrett(m){this.r2=nbi(),this.q3=nbi(),BigInteger.ONE.dlShiftTo(2*m.t,this.r2),this.mu=this.r2.divide(m),this.m=m}Montgomery.prototype.convert=function(x){var r=nbi();return x.abs().dlShiftTo(this.m.t,r),r.divRemTo(this.m,null,r),x.s<0&&0<r.compareTo(BigInteger.ZERO)&&this.m.subTo(r,r),r},Montgomery.prototype.revert=function(x){var r=nbi();return x.copyTo(r),this.reduce(r),r},Montgomery.prototype.reduce=function(x){for(;x.t<=this.mt2;)x[x.t++]=0;for(var i=0;i<this.m.t;++i){var j=32767&x[i],u0=j*this.mpl+((j*this.mph+(x[i]>>15)*this.mpl&this.um)<<15)&x.DM;for(x[j=i+this.m.t]+=this.m.am(0,u0,x,i,0,this.m.t);x[j]>=x.DV;)x[j]-=x.DV,x[++j]++}x.clamp(),x.drShiftTo(this.m.t,x),0<=x.compareTo(this.m)&&x.subTo(this.m,x)},Montgomery.prototype.mulTo=function(x,y,r){x.multiplyTo(y,r),this.reduce(r)},Montgomery.prototype.sqrTo=function(x,r){x.squareTo(r),this.reduce(r)},BigInteger.prototype.copyTo=function(r){for(var i=this.t-1;0<=i;--i)r[i]=this[i];r.t=this.t,r.s=this.s},BigInteger.prototype.fromInt=function(x){this.t=1,this.s=x<0?-1:0,0<x?this[0]=x:x<-1?this[0]=x+this.DV:this.t=0},BigInteger.prototype.fromString=function(s,b){var k;if(16==b)k=4;else if(8==b)k=3;else if(256==b)k=8;else if(2==b)k=1;else if(32==b)k=5;else{if(4!=b)return void this.fromRadix(s,b);k=2}this.t=0,this.s=0;for(var i=s.length,mi=!1,sh=0;0<=--i;){var x=8==k?255&s[i]:intAt(s,i);x<0?"-"==s.charAt(i)&&(mi=!0):(mi=!1,0==sh?this[this.t++]=x:sh+k>this.DB?(this[this.t-1]|=(x&(1<<this.DB-sh)-1)<<sh,this[this.t++]=x>>this.DB-sh):this[this.t-1]|=x<<sh,(sh+=k)>=this.DB&&(sh-=this.DB))}8==k&&0!=(128&s[0])&&(this.s=-1,0<sh&&(this[this.t-1]|=(1<<this.DB-sh)-1<<sh)),this.clamp(),mi&&BigInteger.ZERO.subTo(this,this)},BigInteger.prototype.clamp=function(){for(var c=this.s&this.DM;0<this.t&&this[this.t-1]==c;)--this.t},BigInteger.prototype.dlShiftTo=function(n,r){for(var i=this.t-1;0<=i;--i)r[i+n]=this[i];for(i=n-1;0<=i;--i)r[i]=0;r.t=this.t+n,r.s=this.s},BigInteger.prototype.drShiftTo=function(n,r){for(var i=n;i<this.t;++i)r[i-n]=this[i];r.t=Math.max(this.t-n,0),r.s=this.s},BigInteger.prototype.lShiftTo=function(n,r){for(var bs=n%this.DB,cbs=this.DB-bs,bm=(1<<cbs)-1,ds=Math.floor(n/this.DB),c=this.s<<bs&this.DM,i=this.t-1;0<=i;--i)r[i+ds+1]=this[i]>>cbs|c,c=(this[i]&bm)<<bs;for(i=ds-1;0<=i;--i)r[i]=0;r[ds]=c,r.t=this.t+ds+1,r.s=this.s,r.clamp()},BigInteger.prototype.rShiftTo=function(n,r){r.s=this.s;var ds=Math.floor(n/this.DB);if(ds>=this.t)r.t=0;else{var bs=n%this.DB,cbs=this.DB-bs,bm=(1<<bs)-1;r[0]=this[ds]>>bs;for(var i=ds+1;i<this.t;++i)r[i-ds-1]|=(this[i]&bm)<<cbs,r[i-ds]=this[i]>>bs;0<bs&&(r[this.t-ds-1]|=(this.s&bm)<<cbs),r.t=this.t-ds,r.clamp()}},BigInteger.prototype.subTo=function(a,r){for(var i=0,c=0,m=Math.min(a.t,this.t);i<m;)c+=this[i]-a[i],r[i++]=c&this.DM,c>>=this.DB;if(a.t<this.t){for(c-=a.s;i<this.t;)c+=this[i],r[i++]=c&this.DM,c>>=this.DB;c+=this.s}else{for(c+=this.s;i<a.t;)c-=a[i],r[i++]=c&this.DM,c>>=this.DB;c-=a.s}r.s=c<0?-1:0,c<-1?r[i++]=this.DV+c:0<c&&(r[i++]=c),r.t=i,r.clamp()},BigInteger.prototype.multiplyTo=function(a,r){var x=this.abs(),y=a.abs(),i=x.t;for(r.t=i+y.t;0<=--i;)r[i]=0;for(i=0;i<y.t;++i)r[i+x.t]=x.am(0,y[i],r,i,0,x.t);r.s=0,r.clamp(),this.s!=a.s&&BigInteger.ZERO.subTo(r,r)},BigInteger.prototype.squareTo=function(r){for(var x=this.abs(),i=r.t=2*x.t;0<=--i;)r[i]=0;for(i=0;i<x.t-1;++i){var c=x.am(i,x[i],r,2*i,0,1);(r[i+x.t]+=x.am(i+1,2*x[i],r,2*i+1,c,x.t-i-1))>=x.DV&&(r[i+x.t]-=x.DV,r[i+x.t+1]=1)}0<r.t&&(r[r.t-1]+=x.am(i,x[i],r,2*i,0,1)),r.s=0,r.clamp()},BigInteger.prototype.divRemTo=function(nsh,q,r){var pm=nsh.abs();if(!(pm.t<=0)){var yt=this.abs();if(yt.t<pm.t)return null!=q&&q.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=nbi());var y=nbi(),ts=this.s,ms=nsh.s,nsh=this.DB-nbits(pm[pm.t-1]);0<nsh?(pm.lShiftTo(nsh,y),yt.lShiftTo(nsh,r)):(pm.copyTo(y),yt.copyTo(r));var ys=y.t,y0=y[ys-1];if(0!=y0){var yt=y0*(1<<this.F1)+(1<ys?y[ys-2]>>this.F2:0),d1=this.FV/yt,d2=(1<<this.F1)/yt,e=1<<this.F2,i=r.t,j=i-ys,t=null==q?nbi():q;for(y.dlShiftTo(j,t),0<=r.compareTo(t)&&(r[r.t++]=1,r.subTo(t,r)),BigInteger.ONE.dlShiftTo(ys,t),t.subTo(y,y);y.t<ys;)y[y.t++]=0;for(;0<=--j;){var qd=r[--i]==y0?this.DM:Math.floor(r[i]*d1+(r[i-1]+e)*d2);if((r[i]+=y.am(0,qd,r,j,0,ys))<qd)for(y.dlShiftTo(j,t),r.subTo(t,r);r[i]<--qd;)r.subTo(t,r)}null!=q&&(r.drShiftTo(ys,q),ts!=ms&&BigInteger.ZERO.subTo(q,q)),r.t=ys,r.clamp(),0<nsh&&r.rShiftTo(nsh,r),ts<0&&BigInteger.ZERO.subTo(r,r)}}},BigInteger.prototype.invDigit=function(){if(this.t<1)return 0;var x=this[0];if(0==(1&x))return 0;var y=3&x;return 0<(y=(y=(y=(y=y*(2-(15&x)*y)&15)*(2-(255&x)*y)&255)*(2-((65535&x)*y&65535))&65535)*(2-x*y%this.DV)%this.DV)?this.DV-y:-y},BigInteger.prototype.isEven=function(){return 0==(0<this.t?1&this[0]:this.s)},BigInteger.prototype.exp=function(e,z){if(4294967295<e||e<1)return BigInteger.ONE;var t,r=nbi(),r2=nbi(),g=z.convert(this),i=nbits(e)-1;for(g.copyTo(r);0<=--i;)z.sqrTo(r,r2),0<(e&1<<i)?z.mulTo(r2,g,r):(t=r,r=r2,r2=t);return z.revert(r)},BigInteger.prototype.toString=function(b){if(this.s<0)return"-"+this.negate().toString(b);var k;if(16==b)k=4;else if(8==b)k=3;else if(2==b)k=1;else if(32==b)k=5;else{if(4!=b)return this.toRadix(b);k=2}var d,km=(1<<k)-1,m=!1,r="",i=this.t,p=this.DB-i*this.DB%k;if(0<i--)for(p<this.DB&&0<(d=this[i]>>p)&&(m=!0,r=int2char(d));0<=i;)p<k?(d=(this[i]&(1<<p)-1)<<k-p,d|=this[--i]>>(p+=this.DB-k)):(d=this[i]>>(p-=k)&km,p<=0&&(p+=this.DB,--i)),(m=0<d?!0:m)&&(r+=int2char(d));return m?r:"0"},BigInteger.prototype.negate=function(){var r=nbi();return BigInteger.ZERO.subTo(this,r),r},BigInteger.prototype.abs=function(){return this.s<0?this.negate():this},BigInteger.prototype.compareTo=function(a){var r=this.s-a.s;if(0!=r)return r;var i=this.t;if(0!=(r=i-a.t))return this.s<0?-r:r;for(;0<=--i;)if(0!=(r=this[i]-a[i]))return r;return 0},BigInteger.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)},BigInteger.prototype.mod=function(a){var r=nbi();return this.abs().divRemTo(a,null,r),this.s<0&&0<r.compareTo(BigInteger.ZERO)&&a.subTo(r,r),r},BigInteger.prototype.modPowInt=function(e,z){return z=new(e<256||z.isEven()?Classic:Montgomery)(z),this.exp(e,z)},BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=function(x,y,r){x.multiplyTo(y,r)},NullExp.prototype.sqrTo=function(x,r){x.squareTo(r)},Barrett.prototype.convert=function(x){if(x.s<0||x.t>2*this.m.t)return x.mod(this.m);if(x.compareTo(this.m)<0)return x;var r=nbi();return x.copyTo(r),this.reduce(r),r},Barrett.prototype.revert=function(x){return x},Barrett.prototype.reduce=function(x){for(x.drShiftTo(this.m.t-1,this.r2),x.t>this.m.t+1&&(x.t=this.m.t+1,x.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);x.compareTo(this.r2)<0;)x.dAddOffset(1,this.m.t+1);for(x.subTo(this.r2,x);0<=x.compareTo(this.m);)x.subTo(this.m,x)},Barrett.prototype.mulTo=function(x,y,r){x.multiplyTo(y,r),this.reduce(r)},Barrett.prototype.sqrTo=function(x,r){x.squareTo(r),this.reduce(r)};var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];function parseBigInt(str,r){return new BigInteger(str,r)}BigInteger.prototype.chunkSize=function(r){return Math.floor(Math.LN2*this.DB/Math.log(r))},BigInteger.prototype.toRadix=function(b){if(null==b&&(b=10),0==this.signum()||b<2||36<b)return"0";var cs=this.chunkSize(b),a=Math.pow(b,cs),d=nbv(a),y=nbi(),z=nbi(),r="";for(this.divRemTo(d,y,z);0<y.signum();)r=(a+z.intValue()).toString(b).substr(1)+r,y.divRemTo(d,y,z);return z.intValue().toString(b)+r},BigInteger.prototype.fromRadix=function(s,b){this.fromInt(0);for(var cs=this.chunkSize(b=null==b?10:b),d=Math.pow(b,cs),mi=!1,j=0,w=0,i=0;i<s.length;++i){var x=intAt(s,i);x<0?"-"==s.charAt(i)&&0==this.signum()&&(mi=!0):(w=b*w+x,++j>=cs&&(this.dMultiply(d),this.dAddOffset(w,0),w=j=0))}0<j&&(this.dMultiply(Math.pow(b,j)),this.dAddOffset(w,0)),mi&&BigInteger.ZERO.subTo(this,this)},BigInteger.prototype.fromNumber=function(a,b,t){if("number"==typeof b)if(a<2)this.fromInt(1);else for(this.fromNumber(a,t),this.testBit(a-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(a-1),op_or,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(b);)this.dAddOffset(2,0),this.bitLength()>a&&this.subTo(BigInteger.ONE.shiftLeft(a-1),this);else{var x=[],t=7&a;x.length=1+(a>>3),b.nextBytes(x),0<t?x[0]&=(1<<t)-1:x[0]=0,this.fromString(x,256)}},BigInteger.prototype.bitwiseTo=function(a,op,r){for(var f,m=Math.min(a.t,this.t),i=0;i<m;++i)r[i]=op(this[i],a[i]);if(a.t<this.t){for(f=a.s&this.DM,i=m;i<this.t;++i)r[i]=op(this[i],f);r.t=this.t}else{for(f=this.s&this.DM,i=m;i<a.t;++i)r[i]=op(f,a[i]);r.t=a.t}r.s=op(this.s,a.s),r.clamp()},BigInteger.prototype.changeBit=function(r,op){return r=BigInteger.ONE.shiftLeft(r),this.bitwiseTo(r,op,r),r},BigInteger.prototype.addTo=function(a,r){for(var i=0,c=0,m=Math.min(a.t,this.t);i<m;)c+=this[i]+a[i],r[i++]=c&this.DM,c>>=this.DB;if(a.t<this.t){for(c+=a.s;i<this.t;)c+=this[i],r[i++]=c&this.DM,c>>=this.DB;c+=this.s}else{for(c+=this.s;i<a.t;)c+=a[i],r[i++]=c&this.DM,c>>=this.DB;c+=a.s}r.s=c<0?-1:0,0<c?r[i++]=c:c<-1&&(r[i++]=this.DV+c),r.t=i,r.clamp()},BigInteger.prototype.dMultiply=function(n){this[this.t]=this.am(0,n-1,this,0,0,this.t),++this.t,this.clamp()},BigInteger.prototype.dAddOffset=function(n,w){if(0!=n){for(;this.t<=w;)this[this.t++]=0;for(this[w]+=n;this[w]>=this.DV;)this[w]-=this.DV,++w>=this.t&&(this[this.t++]=0),++this[w]}},BigInteger.prototype.multiplyLowerTo=function(a,n,r){var j,i=Math.min(this.t+a.t,n);for(r.s=0,r.t=i;0<i;)r[--i]=0;for(j=r.t-this.t;i<j;++i)r[i+this.t]=this.am(0,a[i],r,i,0,this.t);for(j=Math.min(a.t,n);i<j;++i)this.am(0,a[i],r,i,0,n-i);r.clamp()},BigInteger.prototype.multiplyUpperTo=function(a,n,r){var i=r.t=this.t+a.t- --n;for(r.s=0;0<=--i;)r[i]=0;for(i=Math.max(n-this.t,0);i<a.t;++i)r[this.t+i-n]=this.am(n-i,a[i],r,0,0,this.t+i-n);r.clamp(),r.drShiftTo(1,r)},BigInteger.prototype.modInt=function(n){if(n<=0)return 0;var d=this.DV%n,r=this.s<0?n-1:0;if(0<this.t)if(0==d)r=this[0]%n;else for(var i=this.t-1;0<=i;--i)r=(d*r+this[i])%n;return r},BigInteger.prototype.millerRabin=function(t){var n1=this.subtract(BigInteger.ONE),k=n1.getLowestSetBit();if(k<=0)return!1;var r=n1.shiftRight(k);lowprimes.length<(t=t+1>>1)&&(t=lowprimes.length);for(var a=nbi(),i=0;i<t;++i){a.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var y=a.modPow(r,this);if(0!=y.compareTo(BigInteger.ONE)&&0!=y.compareTo(n1)){for(var j=1;j++<k&&0!=y.compareTo(n1);)if(0==(y=y.modPowInt(2,this)).compareTo(BigInteger.ONE))return!1;if(0!=y.compareTo(n1))return!1}}return!0},BigInteger.prototype.clone=function(){var r=nbi();return this.copyTo(r),r},BigInteger.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},BigInteger.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},BigInteger.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},BigInteger.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},BigInteger.prototype.toByteArray=function(){var i=this.t,r=[];r[0]=this.s;var d,p=this.DB-i*this.DB%8,k=0;if(0<i--)for(p<this.DB&&(d=this[i]>>p)!=(this.s&this.DM)>>p&&(r[k++]=d|this.s<<this.DB-p);0<=i;)p<8?(d=(this[i]&(1<<p)-1)<<8-p,d|=this[--i]>>(p+=this.DB-8)):(d=this[i]>>(p-=8)&255,p<=0&&(p+=this.DB,--i)),0!=(128&d)&&(d|=-256),0==k&&(128&this.s)!=(128&d)&&++k,(0<k||d!=this.s)&&(r[k++]=d);return r},BigInteger.prototype.equals=function(a){return 0==this.compareTo(a)},BigInteger.prototype.min=function(a){return this.compareTo(a)<0?this:a},BigInteger.prototype.max=function(a){return 0<this.compareTo(a)?this:a},BigInteger.prototype.and=function(a){var r=nbi();return this.bitwiseTo(a,op_and,r),r},BigInteger.prototype.or=function(a){var r=nbi();return this.bitwiseTo(a,op_or,r),r},BigInteger.prototype.xor=function(a){var r=nbi();return this.bitwiseTo(a,op_xor,r),r},BigInteger.prototype.andNot=function(a){var r=nbi();return this.bitwiseTo(a,op_andnot,r),r},BigInteger.prototype.not=function(){for(var r=nbi(),i=0;i<this.t;++i)r[i]=this.DM&~this[i];return r.t=this.t,r.s=~this.s,r},BigInteger.prototype.shiftLeft=function(n){var r=nbi();return n<0?this.rShiftTo(-n,r):this.lShiftTo(n,r),r},BigInteger.prototype.shiftRight=function(n){var r=nbi();return n<0?this.lShiftTo(-n,r):this.rShiftTo(n,r),r},BigInteger.prototype.getLowestSetBit=function(){for(var i=0;i<this.t;++i)if(0!=this[i])return i*this.DB+function(x){if(0==x)return-1;var r=0;return 0==(65535&x)&&(x>>=16,r+=16),0==(255&x)&&(x>>=8,r+=8),0==(15&x)&&(x>>=4,r+=4),0==(3&x)&&(x>>=2,r+=2),0==(1&x)&&++r,r}(this[i]);return this.s<0?this.t*this.DB:-1},BigInteger.prototype.bitCount=function(){for(var r=0,x=this.s&this.DM,i=0;i<this.t;++i)r+=function(x){for(var r=0;0!=x;)x&=x-1,++r;return r}(this[i]^x);return r},BigInteger.prototype.testBit=function(n){var j=Math.floor(n/this.DB);return j>=this.t?0!=this.s:0!=(this[j]&1<<n%this.DB)},BigInteger.prototype.setBit=function(n){return this.changeBit(n,op_or)},BigInteger.prototype.clearBit=function(n){return this.changeBit(n,op_andnot)},BigInteger.prototype.flipBit=function(n){return this.changeBit(n,op_xor)},BigInteger.prototype.add=function(a){var r=nbi();return this.addTo(a,r),r},BigInteger.prototype.subtract=function(a){var r=nbi();return this.subTo(a,r),r},BigInteger.prototype.multiply=function(a){var r=nbi();return this.multiplyTo(a,r),r},BigInteger.prototype.divide=function(a){var r=nbi();return this.divRemTo(a,r,null),r},BigInteger.prototype.remainder=function(a){var r=nbi();return this.divRemTo(a,null,r),r},BigInteger.prototype.divideAndRemainder=function(a){var q=nbi(),r=nbi();return this.divRemTo(a,q,r),new Array(q,r)},BigInteger.prototype.modPow=function(e,m){var i=e.bitLength(),r=nbv(1);if(i<=0)return r;var k=i<18?1:i<48?3:i<144?4:i<768?5:6,z=new(i<8?Classic:m.isEven()?Barrett:Montgomery)(m),g=[],n=3,k1=k-1,km=(1<<k)-1;if(g[1]=z.convert(this),1<k){var g2=nbi();for(z.sqrTo(g[1],g2);n<=km;)g[n]=nbi(),z.mulTo(g2,g[n-2],g[n]),n+=2}for(var w,t,j=e.t-1,is1=!0,r2=nbi(),i=nbits(e[j])-1;0<=j;){for(k1<=i?w=e[j]>>i-k1&km:(w=(e[j]&(1<<i+1)-1)<<k1-i,0<j&&(w|=e[j-1]>>this.DB+i-k1)),n=k;0==(1&w);)w>>=1,--n;if((i-=n)<0&&(i+=this.DB,--j),is1)g[w].copyTo(r),is1=!1;else{for(;1<n;)z.sqrTo(r,r2),z.sqrTo(r2,r),n-=2;0<n?z.sqrTo(r,r2):(t=r,r=r2,r2=t),z.mulTo(r2,g[w],r)}for(;0<=j&&0==(e[j]&1<<i);)z.sqrTo(r,r2),t=r,r=r2,r2=t,--i<0&&(i=this.DB-1,--j)}return z.revert(r)},BigInteger.prototype.modInverse=function(m){var ac=m.isEven();if(this.isEven()&&ac||0==m.signum())return BigInteger.ZERO;for(var u=m.clone(),v=this.clone(),a=nbv(1),b=nbv(0),c=nbv(0),d=nbv(1);0!=u.signum();){for(;u.isEven();)u.rShiftTo(1,u),ac?(a.isEven()&&b.isEven()||(a.addTo(this,a),b.subTo(m,b)),a.rShiftTo(1,a)):b.isEven()||b.subTo(m,b),b.rShiftTo(1,b);for(;v.isEven();)v.rShiftTo(1,v),ac?(c.isEven()&&d.isEven()||(c.addTo(this,c),d.subTo(m,d)),c.rShiftTo(1,c)):d.isEven()||d.subTo(m,d),d.rShiftTo(1,d);0<=u.compareTo(v)?(u.subTo(v,u),ac&&a.subTo(c,a),b.subTo(d,b)):(v.subTo(u,v),ac&&c.subTo(a,c),d.subTo(b,d))}return 0!=v.compareTo(BigInteger.ONE)?BigInteger.ZERO:0<=d.compareTo(m)?d.subtract(m):d.signum()<0?(d.addTo(m,d),d.signum()<0?d.add(m):d):d},BigInteger.prototype.pow=function(e){return this.exp(e,new NullExp)},BigInteger.prototype.gcd=function(a){var x=this.s<0?this.negate():this.clone(),y=a.s<0?a.negate():a.clone();x.compareTo(y)<0&&(g=x,x=y,y=g);var i=x.getLowestSetBit(),g=y.getLowestSetBit();if(g<0)return x;for(0<(g=i<g?i:g)&&(x.rShiftTo(g,x),y.rShiftTo(g,y));0<x.signum();)0<(i=x.getLowestSetBit())&&x.rShiftTo(i,x),0<(i=y.getLowestSetBit())&&y.rShiftTo(i,y),0<=x.compareTo(y)?(x.subTo(y,x),x.rShiftTo(1,x)):(y.subTo(x,y),y.rShiftTo(1,y));return 0<g&&y.lShiftTo(g,y),y},BigInteger.prototype.isProbablePrime=function(t){var i,x=this.abs();if(1==x.t&&x[0]<=lowprimes[lowprimes.length-1]){for(i=0;i<lowprimes.length;++i)if(x[0]==lowprimes[i])return!0;return!1}if(x.isEven())return!1;for(i=1;i<lowprimes.length;){for(var m=lowprimes[i],j=i+1;j<lowprimes.length&&m<lplim;)m*=lowprimes[j++];for(m=x.modInt(m);i<j;)if(m%lowprimes[i++]==0)return!1}return x.millerRabin(t)},BigInteger.prototype.square=function(){var r=nbi();return this.squareTo(r),r};class RSAKey{constructor(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}}RSAKey.prototype.doPublic=function(x){return x.modPowInt(this.e,this.n)},RSAKey.prototype.setPublic=function(N,E){null!=N&&null!=E&&0<N.length&&0<E.length?(this.n=parseBigInt(N,16),this.e=parseInt(E,16)):console.error("Invalid RSA public key")},RSAKey.prototype.encrypt=function(h){return null==(h=function(s,n){if(n<s.length+11)return console.error("Message too long for RSA"),null;for(var ba=[],i=s.length-1;0<=i&&0<n;){var c=s.charCodeAt(i--);c<128?ba[--n]=c:127<c&&c<2048?(ba[--n]=63&c|128,ba[--n]=c>>6|192):(ba[--n]=63&c|128,ba[--n]=c>>6&63|128,ba[--n]=c>>12|224)}ba[--n]=0;for(var rng=new SecureRandom,x=[];2<n;){for(x[0]=0;0==x[0];)rng.nextBytes(x);ba[--n]=x[0]}return ba[--n]=2,ba[--n]=0,new BigInteger(ba)}(h,this.n.bitLength()+7>>3))||null==(h=this.doPublic(h))?null:0==(1&(h=h.toString(16)).length)?h:"0"+h},RSAKey.prototype.doPrivate=function(x){if(null==this.p||null==this.q)return x.modPow(this.d,this.n);for(var xp=x.mod(this.p).modPow(this.dmp1,this.p),xq=x.mod(this.q).modPow(this.dmq1,this.q);xp.compareTo(xq)<0;)xp=xp.add(this.p);return xp.subtract(xq).multiply(this.coeff).mod(this.p).multiply(this.q).add(xq)},RSAKey.prototype.setPrivate=function(N,E,D){null!=N&&null!=E&&0<N.length&&0<E.length?(this.n=parseBigInt(N,16),this.e=parseInt(E,16),this.d=parseBigInt(D,16)):console.error("Invalid RSA private key")},RSAKey.prototype.setPrivateEx=function(N,E,D,P,Q,DP,DQ,C){null!=N&&null!=E&&0<N.length&&0<E.length?(this.n=parseBigInt(N,16),this.e=parseInt(E,16),this.d=parseBigInt(D,16),this.p=parseBigInt(P,16),this.q=parseBigInt(Q,16),this.dmp1=parseBigInt(DP,16),this.dmq1=parseBigInt(DQ,16),this.coeff=parseBigInt(C,16)):console.error("Invalid RSA private key")},RSAKey.prototype.generate=function(B,E){var rng=new SecureRandom,qs=B>>1;this.e=parseInt(E,16);for(var ee=new BigInteger(E,16);;){for(;this.p=new BigInteger(B-qs,1,rng),0!=this.p.subtract(BigInteger.ONE).gcd(ee).compareTo(BigInteger.ONE)||!this.p.isProbablePrime(10););for(;this.q=new BigInteger(qs,1,rng),0!=this.q.subtract(BigInteger.ONE).gcd(ee).compareTo(BigInteger.ONE)||!this.q.isProbablePrime(10););this.p.compareTo(this.q)<=0&&(phi=this.p,this.p=this.q,this.q=phi);var p1=this.p.subtract(BigInteger.ONE),q1=this.q.subtract(BigInteger.ONE),phi=p1.multiply(q1);if(0==phi.gcd(ee).compareTo(BigInteger.ONE)){this.n=this.p.multiply(this.q),this.d=ee.modInverse(phi),this.dmp1=this.d.mod(p1),this.dmq1=this.d.mod(q1),this.coeff=this.q.modInverse(this.p);break}}},RSAKey.prototype.decrypt=function(m){return m=parseBigInt(m,16),null==(m=this.doPrivate(m))?null:function(d,n){for(var b=d.toByteArray(),i=0;i<b.length&&0==b[i];)++i;if(b.length-i!=n-1||2!=b[i])return null;for(++i;0!=b[i];)if(++i>=b.length)return null;for(var ret="";++i<b.length;){var c=255&b[i];c<128?ret+=String.fromCharCode(c):191<c&&c<224?(ret+=String.fromCharCode((31&c)<<6|63&b[i+1]),++i):(ret+=String.fromCharCode((15&c)<<12|(63&b[i+1])<<6|63&b[i+2]),i+=2)}return ret}(m,this.n.bitLength()+7>>3)};const Base64={};let decoder;Base64.decode=function(a){if(void 0===decoder){var ignore="= \f\n\r\t \u2028\u2029";for(decoder=[],i=0;i<64;++i)decoder["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i)]=i;for(i=0;i<ignore.length;++i)decoder[ignore.charAt(i)]=-1}for(var out=[],bits=0,char_count=0,i=0;i<a.length;++i){var c=a.charAt(i);if("="==c)break;if(-1!=(c=decoder[c])){if(void 0===c)throw"Illegal character at offset "+i;bits|=c,4<=++char_count?(out[out.length]=bits>>16,out[out.length]=bits>>8&255,out[out.length]=255&bits,char_count=bits=0):bits<<=6}}switch(char_count){case 1:throw"Base64 encoding incomplete: at least 2 bits missing";case 2:out[out.length]=bits>>10;break;case 3:out[out.length]=bits>>16,out[out.length]=bits>>8&255}return out},Base64.re=/-----BEGIN [^-]+-----([A-Za-z0-9+\/=\s]+)-----END [^-]+-----|begin-base64[^\n]+\n([A-Za-z0-9+\/=\s]+)====/,Base64.unarmor=function(a){var m=Base64.re.exec(a);if(m)if(m[1])a=m[1];else{if(!m[2])throw"RegExp out of sync";a=m[2]}return Base64.decode(a)};const Hex={};let decoder$1;Hex.decode=function(a){if(void 0===decoder$1){var hex="0123456789ABCDEF",ignore=" \f\n\r\t \u2028\u2029";for(decoder$1=[],i=0;i<16;++i)decoder$1[hex.charAt(i)]=i;for(hex=hex.toLowerCase(),i=10;i<16;++i)decoder$1[hex.charAt(i)]=i;for(i=0;i<ignore.length;++i)decoder$1[ignore.charAt(i)]=-1}for(var out=[],bits=0,char_count=0,i=0;i<a.length;++i){var c=a.charAt(i);if("="==c)break;if(-1!=(c=decoder$1[c])){if(void 0===c)throw"Illegal character at offset "+i;bits|=c,2<=++char_count?(out[out.length]=bits,char_count=bits=0):bits<<=4}}if(char_count)throw"Hex encoding incomplete: 4 bits missing";return out};const JSX={};JSX.env=JSX.env||{};var L=JSX,OP=Object.prototype,ADD=["toString","valueOf"];JSX.env.parseUA=function(m){function numberify(s){var c=0;return parseFloat(s.replace(/\./g,function(){return 1==c++?"":"."}))}var ua=navigator,o={ie:0,opera:0,gecko:0,webkit:0,chrome:0,mobile:null,air:0,ipad:0,iphone:0,ipod:0,ios:null,android:0,webos:0,caja:ua&&ua.cajaVersion,secure:!1,os:null},ua=m||navigator&&navigator.userAgent,m=window&&window.location,m=m&&m.href;return o.secure=m&&0===m.toLowerCase().indexOf("https"),ua&&(/windows|win32/i.test(ua)?o.os="windows":/macintosh/i.test(ua)?o.os="macintosh":/rhino/i.test(ua)&&(o.os="rhino"),/KHTML/.test(ua)&&(o.webkit=1),(m=ua.match(/AppleWebKit\/([^\s]*)/))&&m[1]&&(o.webkit=numberify(m[1]),/ Mobile\//.test(ua)?(o.mobile="Apple",(m=ua.match(/OS ([^\s]*)/))&&m[1]&&(m=numberify(m[1].replace("_","."))),o.ios=m,o.ipad=o.ipod=o.iphone=0,(m=ua.match(/iPad|iPod|iPhone/))&&m[0]&&(o[m[0].toLowerCase()]=o.ios)):((m=ua.match(/NokiaN[^\/]*|Android \d\.\d|webOS\/\d\.\d/))&&(o.mobile=m[0]),/webOS/.test(ua)&&(o.mobile="WebOS",(m=ua.match(/webOS\/([^\s]*);/))&&m[1]&&(o.webos=numberify(m[1]))),/ Android/.test(ua)&&(o.mobile="Android",(m=ua.match(/Android ([^\s]*);/))&&m[1]&&(o.android=numberify(m[1])))),(m=ua.match(/Chrome\/([^\s]*)/))&&m[1]?o.chrome=numberify(m[1]):(m=ua.match(/AdobeAIR\/([^\s]*)/))&&(o.air=m[0])),o.webkit||((m=ua.match(/Opera[\s\/]([^\s]*)/))&&m[1]?(o.opera=numberify(m[1]),(m=ua.match(/Version\/([^\s]*)/))&&m[1]&&(o.opera=numberify(m[1])),(m=ua.match(/Opera Mini[^;]*/))&&(o.mobile=m[0])):(m=ua.match(/MSIE\s([^;]*)/))&&m[1]?o.ie=numberify(m[1]):(m=ua.match(/Gecko\/([^\s]*)/))&&(o.gecko=1,(m=ua.match(/rv:([^\s\)]*)/))&&m[1]&&(o.gecko=numberify(m[1]))))),o},JSX.env.ua=JSX.env.parseUA(),JSX.isFunction=function(o){return"function"==typeof o||"[object Function]"===OP.toString.apply(o)},JSX._IEEnumFix=JSX.env.ua.ie?function(r,s){for(var fname,f,i=0;i<ADD.length;i+=1)f=s[fname=ADD[i]],L.isFunction(f)&&f!=OP[fname]&&(r[fname]=f)}:function(){},JSX.extend=function(subc,superc,overrides){if(!superc||!subc)throw new Error("extend failed, please check that all dependencies are included.");function F(){}if(F.prototype=superc.prototype,subc.prototype=new F,(subc.prototype.constructor=subc).superclass=superc.prototype,superc.prototype.constructor==OP.constructor&&(superc.prototype.constructor=superc),overrides){for(var i in overrides)L.hasOwnProperty(overrides,i)&&(subc.prototype[i]=overrides[i]);L._IEEnumFix(subc.prototype,overrides)}};const KJUR={};void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),KJUR.asn1.ASN1Util=new function(){this.integerToByteHex=function(h){h=h.toString(16);return h=h.length%2==1?"0"+h:h},this.bigIntToMinTwosComplementsHex=function(bigIntegerValue){if("-"!=(h=bigIntegerValue.toString(16)).substr(0,1))h.length%2==1?h="0"+h:h.match(/^[0-7]/)||(h="00"+h);else{var xorLen=h.substr(1).length;xorLen%2==1?xorLen+=1:h.match(/^[0-7]/)||(xorLen+=2);for(var hMask="",i=0;i<xorLen;i++)hMask+="f";var h=new BigInteger(hMask,16).xor(bigIntegerValue).add(BigInteger.ONE).toString(16).replace(/^-/,"")}return h},this.getPEMStringFromHex=function(dataWA,pemHeader){dataWA=CryptoJS.enc.Hex.parse(dataWA);return"-----BEGIN "+pemHeader+"-----\r\n"+CryptoJS.enc.Base64.stringify(dataWA).replace(/(.{64})/g,"$1\r\n").replace(/\r\n$/,"")+"\r\n-----END "+pemHeader+"-----\r\n"}},KJUR.asn1.ASN1Object=function(){this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw"this.hV is null or undefined.";if(this.hV.length%2==1)throw"value hex must be even length: n="+"".length+",v="+this.hV;var n=this.hV.length/2,hN=n.toString(16);if(hN.length%2==1&&(hN="0"+hN),n<128)return hN;var hNlen=hN.length/2;if(15<hNlen)throw"ASN.1 length too long to represent by 8x: n = "+n.toString(16);return(128+hNlen).toString(16)+hN},this.getEncodedHex=function(){return null!=this.hTLV&&!this.isModified||(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getValueHex=function(){return this.getEncodedHex(),this.hV},this.getFreshValueHex=function(){return""}},KJUR.asn1.DERAbstractString=function(params){KJUR.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(newS){this.hTLV=null,this.isModified=!0,this.s=newS,this.hV=stohex(this.s)},this.setStringHex=function(newHexString){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=newHexString},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.str?this.setString(params.str):void 0!==params.hex&&this.setStringHex(params.hex))},JSX.extend(KJUR.asn1.DERAbstractString,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractTime=function(params){KJUR.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(d){return utc=d.getTime()+6e4*d.getTimezoneOffset(),new Date(utc)},this.formatDate=function(year,type){var pad=this.zeroPadding,d=this.localDateToUTC(year),year=String(d.getFullYear());return(year="utc"==type?year.substr(2,2):year)+pad(String(d.getMonth()+1),2)+pad(String(d.getDate()),2)+pad(String(d.getHours()),2)+pad(String(d.getMinutes()),2)+pad(String(d.getSeconds()),2)+"Z"},this.zeroPadding=function(s,len){return s.length>=len?s:new Array(len-s.length+1).join("0")+s},this.getString=function(){return this.s},this.setString=function(newS){this.hTLV=null,this.isModified=!0,this.s=newS,this.hV=stohex(this.s)},this.setByDateValue=function(year,month,day,hour,min,dateObject){dateObject=new Date(Date.UTC(year,month-1,day,hour,min,dateObject,0));this.setByDate(dateObject)},this.getFreshValueHex=function(){return this.hV}},JSX.extend(KJUR.asn1.DERAbstractTime,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractStructured=function(params){KJUR.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(asn1ObjectArray){this.hTLV=null,this.isModified=!0,this.asn1Array=asn1ObjectArray},this.appendASN1Object=function(asn1Object){this.hTLV=null,this.isModified=!0,this.asn1Array.push(asn1Object)},this.asn1Array=new Array,void 0!==params&&void 0!==params.array&&(this.asn1Array=params.array)},JSX.extend(KJUR.asn1.DERAbstractStructured,KJUR.asn1.ASN1Object),KJUR.asn1.DERBoolean=function(){KJUR.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV="0101ff"},JSX.extend(KJUR.asn1.DERBoolean,KJUR.asn1.ASN1Object),KJUR.asn1.DERInteger=function(params){KJUR.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.setByBigInteger=function(bigIntegerValue){this.hTLV=null,this.isModified=!0,this.hV=KJUR.asn1.ASN1Util.bigIntToMinTwosComplementsHex(bigIntegerValue)},this.setByInteger=function(bi){bi=new BigInteger(String(bi),10);this.setByBigInteger(bi)},this.setValueHex=function(newHexString){this.hV=newHexString},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.bigint?this.setByBigInteger(params.bigint):void 0!==params.int?this.setByInteger(params.int):void 0!==params.hex&&this.setValueHex(params.hex))},JSX.extend(KJUR.asn1.DERInteger,KJUR.asn1.ASN1Object),KJUR.asn1.DERBitString=function(params){KJUR.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(newHexStringIncludingUnusedBits){this.hTLV=null,this.isModified=!0,this.hV=newHexStringIncludingUnusedBits},this.setUnusedBitsAndHexValue=function(hUnusedBits,hValue){if(hUnusedBits<0||7<hUnusedBits)throw"unused bits shall be from 0 to 7: u = "+hUnusedBits;hUnusedBits="0"+hUnusedBits;this.hTLV=null,this.isModified=!0,this.hV=hUnusedBits+hValue},this.setByBinaryString=function(binaryString){var unusedBits=8-(binaryString=binaryString.replace(/0+$/,"")).length%8;8==unusedBits&&(unusedBits=0);for(var i=0;i<=unusedBits;i++)binaryString+="0";for(var h="",i=0;i<binaryString.length-1;i+=8){var x=binaryString.substr(i,8),x=parseInt(x,2).toString(16);h+=x=1==x.length?"0"+x:x}this.hTLV=null,this.isModified=!0,this.hV="0"+unusedBits+h},this.setByBooleanArray=function(booleanArray){for(var s="",i=0;i<booleanArray.length;i++)1==booleanArray[i]?s+="1":s+="0";this.setByBinaryString(s)},this.newFalseArray=function(nLength){for(var a=new Array(nLength),i=0;i<nLength;i++)a[i]=!1;return a},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.hex?this.setHexValueIncludingUnusedBits(params.hex):void 0!==params.bin?this.setByBinaryString(params.bin):void 0!==params.array&&this.setByBooleanArray(params.array))},JSX.extend(KJUR.asn1.DERBitString,KJUR.asn1.ASN1Object),KJUR.asn1.DEROctetString=function(params){KJUR.asn1.DEROctetString.superclass.constructor.call(this,params),this.hT="04"},JSX.extend(KJUR.asn1.DEROctetString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNull=function(){KJUR.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},JSX.extend(KJUR.asn1.DERNull,KJUR.asn1.ASN1Object),KJUR.asn1.DERObjectIdentifier=function(params){function itox(h){return h=1==(h=h.toString(16)).length?"0"+h:h}KJUR.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(newHexString){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=newHexString},this.setValueOidString=function(i0){if(!i0.match(/^[0-9.]+$/))throw"malformed oid string: "+i0;var h="",a=i0.split("."),i0=40*parseInt(a[0])+parseInt(a[1]);h+=itox(i0),a.splice(0,2);for(var i=0;i<a.length;i++)h+=function(roid){var h="",padLen=7-(b=new BigInteger(roid,10).toString(2)).length%7;7==padLen&&(padLen=0);for(var bPad="",i=0;i<padLen;i++)bPad+="0";for(var b=bPad+b,i=0;i<b.length-1;i+=7){var b8=b.substr(i,7);i!=b.length-7&&(b8="1"+b8),h+=itox(parseInt(b8,2))}return h}(a[i]);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=h},this.setValueName=function(oid){if(void 0===KJUR.asn1.x509.OID.name2oidList[oid])throw"DERObjectIdentifier oidName undefined: "+oid;oid=KJUR.asn1.x509.OID.name2oidList[oid];this.setValueOidString(oid)},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.oid?this.setValueOidString(params.oid):void 0!==params.hex?this.setValueHex(params.hex):void 0!==params.name&&this.setValueName(params.name))},JSX.extend(KJUR.asn1.DERObjectIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.DERUTF8String=function(params){KJUR.asn1.DERUTF8String.superclass.constructor.call(this,params),this.hT="0c"},JSX.extend(KJUR.asn1.DERUTF8String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNumericString=function(params){KJUR.asn1.DERNumericString.superclass.constructor.call(this,params),this.hT="12"},JSX.extend(KJUR.asn1.DERNumericString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERPrintableString=function(params){KJUR.asn1.DERPrintableString.superclass.constructor.call(this,params),this.hT="13"},JSX.extend(KJUR.asn1.DERPrintableString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERTeletexString=function(params){KJUR.asn1.DERTeletexString.superclass.constructor.call(this,params),this.hT="14"},JSX.extend(KJUR.asn1.DERTeletexString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERIA5String=function(params){KJUR.asn1.DERIA5String.superclass.constructor.call(this,params),this.hT="16"},JSX.extend(KJUR.asn1.DERIA5String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERUTCTime=function(params){KJUR.asn1.DERUTCTime.superclass.constructor.call(this,params),this.hT="17",this.setByDate=function(dateObject){this.hTLV=null,this.isModified=!0,this.date=dateObject,this.s=this.formatDate(this.date,"utc"),this.hV=stohex(this.s)},void 0!==params&&(void 0!==params.str?this.setString(params.str):void 0!==params.hex?this.setStringHex(params.hex):void 0!==params.date&&this.setByDate(params.date))},JSX.extend(KJUR.asn1.DERUTCTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERGeneralizedTime=function(params){KJUR.asn1.DERGeneralizedTime.superclass.constructor.call(this,params),this.hT="18",this.setByDate=function(dateObject){this.hTLV=null,this.isModified=!0,this.date=dateObject,this.s=this.formatDate(this.date,"gen"),this.hV=stohex(this.s)},void 0!==params&&(void 0!==params.str?this.setString(params.str):void 0!==params.hex?this.setStringHex(params.hex):void 0!==params.date&&this.setByDate(params.date))},JSX.extend(KJUR.asn1.DERGeneralizedTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERSequence=function(params){KJUR.asn1.DERSequence.superclass.constructor.call(this,params),this.hT="30",this.getFreshValueHex=function(){for(var h="",i=0;i<this.asn1Array.length;i++)h+=this.asn1Array[i].getEncodedHex();return this.hV=h,this.hV}},JSX.extend(KJUR.asn1.DERSequence,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERSet=function(params){KJUR.asn1.DERSet.superclass.constructor.call(this,params),this.hT="31",this.getFreshValueHex=function(){for(var a=new Array,i=0;i<this.asn1Array.length;i++){var asn1Obj=this.asn1Array[i];a.push(asn1Obj.getEncodedHex())}return a.sort(),this.hV=a.join(""),this.hV}},JSX.extend(KJUR.asn1.DERSet,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERTaggedObject=function(params){KJUR.asn1.DERTaggedObject.superclass.constructor.call(this),this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.setASN1Object=function(isExplicitFlag,tagNoHex,asn1Object){this.hT=tagNoHex,this.isExplicit=isExplicitFlag,this.asn1Object=asn1Object,this.isExplicit?(this.hV=this.asn1Object.getEncodedHex(),this.hTLV=null,this.isModified=!0):(this.hV=null,this.hTLV=asn1Object.getEncodedHex(),this.hTLV=this.hTLV.replace(/^../,tagNoHex),this.isModified=!1)},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.tag&&(this.hT=params.tag),void 0!==params.explicit&&(this.isExplicit=params.explicit),void 0!==params.obj&&(this.asn1Object=params.obj,this.setASN1Object(this.isExplicit,this.hT,this.asn1Object)))},JSX.extend(KJUR.asn1.DERTaggedObject,KJUR.asn1.ASN1Object);var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function hex2b64(h){for(var c,ret="",i=0;i+3<=h.length;i+=3)c=parseInt(h.substring(i,i+3),16),ret+=b64map.charAt(c>>6)+b64map.charAt(63&c);for(i+1==h.length?(c=parseInt(h.substring(i,i+1),16),ret+=b64map.charAt(c<<2)):i+2==h.length&&(c=parseInt(h.substring(i,i+2),16),ret+=b64map.charAt(c>>2)+b64map.charAt((3&c)<<4));0<(3&ret.length);)ret+="=";return ret}ASN1.prototype.getHexStringValue=function(){var hexString=this.toHexString(),offset=2*this.header,length=2*this.length;return hexString.substr(offset,length)},RSAKey.prototype.parseKey=function(pem){try{var modulus=0,public_exponent=0,der=/^\s*(?:[0-9A-Fa-f][0-9A-Fa-f]\s*)+$/.test(pem)?Hex.decode(pem):Base64.unarmor(pem),asn1=ASN1.decode(der);if(9===(asn1=3===asn1.sub.length?asn1.sub[2].sub[0]:asn1).sub.length){modulus=asn1.sub[1].getHexStringValue(),this.n=parseBigInt(modulus,16),public_exponent=asn1.sub[2].getHexStringValue(),this.e=parseInt(public_exponent,16);var private_exponent=asn1.sub[3].getHexStringValue();this.d=parseBigInt(private_exponent,16);var prime1=asn1.sub[4].getHexStringValue();this.p=parseBigInt(prime1,16);var prime2=asn1.sub[5].getHexStringValue();this.q=parseBigInt(prime2,16);var exponent1=asn1.sub[6].getHexStringValue();this.dmp1=parseBigInt(exponent1,16);var exponent2=asn1.sub[7].getHexStringValue();this.dmq1=parseBigInt(exponent2,16);var coefficient=asn1.sub[8].getHexStringValue();this.coeff=parseBigInt(coefficient,16)}else{if(2!==asn1.sub.length)return!1;var sequence=asn1.sub[1].sub[0],modulus=sequence.sub[0].getHexStringValue();this.n=parseBigInt(modulus,16),public_exponent=sequence.sub[1].getHexStringValue(),this.e=parseInt(public_exponent,16)}return!0}catch(ex){return!1}},RSAKey.prototype.getPrivateBaseKey=function(){var options={array:[new KJUR.asn1.DERInteger({int:0}),new KJUR.asn1.DERInteger({bigint:this.n}),new KJUR.asn1.DERInteger({int:this.e}),new KJUR.asn1.DERInteger({bigint:this.d}),new KJUR.asn1.DERInteger({bigint:this.p}),new KJUR.asn1.DERInteger({bigint:this.q}),new KJUR.asn1.DERInteger({bigint:this.dmp1}),new KJUR.asn1.DERInteger({bigint:this.dmq1}),new KJUR.asn1.DERInteger({bigint:this.coeff})]};return new KJUR.asn1.DERSequence(options).getEncodedHex()},RSAKey.prototype.getPrivateBaseKeyB64=function(){return hex2b64(this.getPrivateBaseKey())},RSAKey.prototype.getPublicBaseKey=function(){var options={array:[new KJUR.asn1.DERObjectIdentifier({oid:"1.2.840.113549.1.1.1"}),new KJUR.asn1.DERNull]},first_sequence=new KJUR.asn1.DERSequence(options),options={array:[new KJUR.asn1.DERInteger({bigint:this.n}),new KJUR.asn1.DERInteger({int:this.e})]};return options={hex:"00"+new KJUR.asn1.DERSequence(options).getEncodedHex()},options={array:[first_sequence,new KJUR.asn1.DERBitString(options)]},new KJUR.asn1.DERSequence(options).getEncodedHex()},RSAKey.prototype.getPublicBaseKeyB64=function(){return hex2b64(this.getPublicBaseKey())},RSAKey.prototype.wordwrap=function(str,width){return width=width||64,str&&str.match(RegExp("(.{1,"+width+"})( +|$\n?)|(.{1,"+width+"})","g")).join("\n")},RSAKey.prototype.getPrivateKey=function(){var key="-----BEGIN RSA PRIVATE KEY-----\n";return key+=this.wordwrap(this.getPrivateBaseKeyB64())+"\n",key+="-----END RSA PRIVATE KEY-----"},RSAKey.prototype.getPublicKey=function(){var key="-----BEGIN PUBLIC KEY-----\n";return key+=this.wordwrap(this.getPublicBaseKeyB64())+"\n",key+="-----END PUBLIC KEY-----"},RSAKey.prototype.hasPublicKeyProperty=function(obj){return(obj=obj||{}).hasOwnProperty("n")&&obj.hasOwnProperty("e")},RSAKey.prototype.hasPrivateKeyProperty=function(obj){return(obj=obj||{}).hasOwnProperty("n")&&obj.hasOwnProperty("e")&&obj.hasOwnProperty("d")&&obj.hasOwnProperty("p")&&obj.hasOwnProperty("q")&&obj.hasOwnProperty("dmp1")&&obj.hasOwnProperty("dmq1")&&obj.hasOwnProperty("coeff")},RSAKey.prototype.parsePropertiesFrom=function(obj){this.n=obj.n,this.e=obj.e,obj.hasOwnProperty("d")&&(this.d=obj.d,this.p=obj.p,this.q=obj.q,this.dmp1=obj.dmp1,this.dmq1=obj.dmq1,this.coeff=obj.coeff)};class JSEncryptRSAKey extends RSAKey{constructor(key){super(),key&&("string"==typeof key?this.parseKey(key):(this.hasPrivateKeyProperty(key)||this.hasPublicKeyProperty(key))&&this.parsePropertiesFrom(key))}}class JSEncrypt{constructor(options){options=options||{},this.default_key_size=parseInt(options.default_key_size)||1024,this.default_public_exponent=options.default_public_exponent||"010001",this.log=options.log||!1,this.key=null}}JSEncrypt.prototype.setKey=function(key){this.log&&this.key&&console.warn("A key was already set, overriding existing."),this.key=new JSEncryptRSAKey(key)},JSEncrypt.prototype.setPrivateKey=function(privkey){this.setKey(privkey)},JSEncrypt.prototype.setPublicKey=function(pubkey){this.setKey(pubkey)},JSEncrypt.prototype.decrypt=function(string){try{return this.getKey().decrypt(function(s){for(var slop,ret="",k=0,i=0;i<s.length&&"="!=s.charAt(i);++i){var v=b64map.indexOf(s.charAt(i));v<0||(k=0==k?(ret+=int2char(v>>2),slop=3&v,1):1==k?(ret+=int2char(slop<<2|v>>4),slop=15&v,2):2==k?(ret+=int2char(slop),ret+=int2char(v>>2),slop=3&v,3):(ret+=int2char(slop<<2|v>>4),ret+=int2char(15&v),0))}return 1==k&&(ret+=int2char(slop<<2)),ret}(string))}catch(ex){return!1}},JSEncrypt.prototype.encrypt=function(string){try{return hex2b64(this.getKey().encrypt(string))}catch(ex){return!1}},JSEncrypt.prototype.getKey=function(cb){if(!this.key){if(this.key=new JSEncryptRSAKey,cb&&"[object Function]"==={}.toString.call(cb))return void this.key.generateAsync(this.default_key_size,this.default_public_exponent,cb);this.key.generate(this.default_key_size,this.default_public_exponent)}return this.key},JSEncrypt.prototype.getPrivateKey=function(){return this.getKey().getPrivateKey()},JSEncrypt.prototype.getPrivateKeyB64=function(){return this.getKey().getPrivateBaseKeyB64()},JSEncrypt.prototype.getPublicKey=function(){return this.getKey().getPublicKey()},JSEncrypt.prototype.getPublicKeyB64=function(){return this.getKey().getPublicBaseKeyB64()};class BaseTransport{constructor(endpoint,stream_type,config=0){this.stream_type=stream_type,this.endpoint=endpoint,this.eventSource=new EventEmitter,this.dataQueue=[]}static canTransfer(stream_type){return BaseTransport.streamTypes().includes(stream_type)}static streamTypes(){return[]}destroy(){this.eventSource.destroy()}connect(){}disconnect(){}reconnect(){return this.disconnect().then(()=>this.connect())}setEndpoint(endpoint){return this.endpoint=endpoint,this.reconnect()}send(data){}prepare(data){}}/^((?!chrome|android).)*safari/i.test(navigator.userAgent);function SMediaError(data){if(data instanceof SMediaError)return data;"number"==typeof data?this.code=data:"string"==typeof value&&(this.message=data),this.message||(this.message=SMediaError.defaultMessages[this.code]||"")}SMediaError.prototype.code=0,SMediaError.prototype.message="",SMediaError.errorTypes=["MEDIA_ERR_CUSTOM","MEDIA_ERR_ABORTED","MEDIA_ERR_NETWORK","MEDIA_ERR_DECODE","MEDIA_ERR_SRC_NOT_SUPPORTED","MEDIA_ERR_ENCRYPTED","MEDIA_ERR_TRANSPORT"],SMediaError.defaultMessages={1:"The fetching of the associated resource was aborted by the user's request.",2:"Some kind of network error occurred which prevented the media from being successfully fetched, despite having previously been available.",3:"Despite having previously been determined to be usable, an error occurred while trying to decode the media resource, resulting in an error.",4:"The associated resource or media provider object (such as a MediaStream) has been found to be unsuitable.",5:"The media is encrypted and we do not have the keys to decrypt it.",6:"Transport error"};for(let errIndex=0;errIndex<SMediaError.errorTypes.length;errIndex++)SMediaError[SMediaError.errorTypes[errIndex]]=errIndex,SMediaError.prototype[SMediaError.errorTypes[errIndex]]=errIndex;var level;const Log$a=getTagged("transport:ws"),LogI=getTagged("info");class WebsocketTransport extends BaseTransport{constructor(endpoint,stream_type,options={socket:`${location.protocol.replace("http","ws")}//${location.host}/ws/`,workers:1}){super(endpoint,stream_type),this.proxies=[],this.currentProxy=0,this.workers=1,this.socket_url=options.socket,this.ready=this.connect(),this.packet=[],this.packetsize=0,this.packettotal=0}destroy(){return this.disconnect().then(()=>super.destroy())}static canTransfer(stream_type){return WebsocketTransport.streamTypes().includes(stream_type)}static streamTypes(){return["hls","rtsp"]}connect(){return this.disconnect().then(()=>{let promises=[];for(let i=0;i<this.workers;++i){let proxy=new WebSocketProxy(this.socket_url,this.endpoint,this.stream_type);proxy.set_info_handler(info=>{this.eventSource.dispatchEvent("info",info)}),proxy.set_error_handler(error=>{this.eventSource.dispatchEvent("error",error)}),proxy.set_disconnect_handler(error=>{this.eventSource.dispatchEvent("disconnected",{code:error.code,reason:error.reason}),[1e3,1006,1013,1011,3e3,12592].includes(error.code)&&setTimeout(()=>{this.ready&&this.ready.reject&&this.ready.reject(),this.ready=this.connect()},3e3)}),proxy.set_data_handler(data=>{if(0!=data.byteLength){if(0==this.packettotal)this.packet=new Uint8Array(data),this.packetsize=4+(this.packet[2]<<8|this.packet[3]);else{var inputtmp=new Uint8Array(data);let outtmp=new Uint8Array(this.packet.length+inputtmp.length);outtmp.set(this.packet,0),outtmp.set(inputtmp,this.packet.length),this.packet=outtmp,this.packetsize=4+(this.packet[2]<<8|this.packet[3])}for(this.packettotal+=data.byteLength;4<this.packettotal&&this.packettotal>=this.packetsize;){if(this.packettotal==this.packetsize){this.dataQueue.push(this.packet),this.eventSource.dispatchEvent("data"),this.packet=null,this.packettotal=0,this.packetsize=0;break}var remainsize=this.packetsize;this.dataQueue.push(this.packet.subarray(0,remainsize)),this.eventSource.dispatchEvent("data"),this.packet=this.packet.subarray(remainsize),this.packettotal-=remainsize,this.packetsize=4+(this.packet[2]<<8|this.packet[3])}}}),promises.push(proxy.connect().then(()=>{this.eventSource.dispatchEvent("connected")}).catch(e=>{throw this.eventSource.dispatchEvent("error"),new Error(e)})),this.proxies.push(proxy)}return Promise.all(promises)})}disconnect(){let promises=[];for(let i=0;i<this.proxies.length;++i)promises.push(this.proxies[i].close());return this.proxies=[],this.proxies.length?Promise.all(promises):Promise.resolve()}socket(){return this.proxies[this.currentProxy++%this.proxies.length]}send(res,fn){res=this.socket().send(res);return fn&&fn(res.seq),res.promise}}class WSPProtocol{static get PROTO(){return"WSP"}static get V1_1(){return"1.1"}static get CMD_INIT(){return"INIT"}static get CMD_JOIN(){return"JOIN"}static get CMD_WRAP(){return"WRAP"}static get CMD_GET_INFO(){return"GET_INFO"}static get WCC_INVALID_DOMAIN(){return 4e3}constructor(ver){this.ver=ver}build(cmd,data,payload=""){let data_str="";for(var k in data.seq||(data.seq=++WSPProtocol.seq),data)data_str+=`${k}: ${data[k]}\r\n`;return`${WSPProtocol.PROTO}/${this.ver} ${cmd}\r\n${data_str}\r\n${payload}`}static parse(data){var payIdx=data.indexOf("\r\n\r\n");let lines=data.substr(0,payIdx).split("\r\n");var hdr=lines.shift().match(new RegExp(`${WSPProtocol.PROTO}/${WSPProtocol.V1_1}\\s+(\\d+)\\s+(.+)`));if(hdr){let res={code:Number(hdr[1]),msg:hdr[2],data:{},payload:""};for(;lines.length;){let line=lines.shift();if(!line)break;{let[k,v]=line.split(":");res.data[k.trim()]=v.trim()}}return res.payload=data.substr(payIdx+4),res}return null}}WSPProtocol.seq=0;class WebSocketProxy{static get CHN_CONTROL(){return"control"}static get CHN_DATA(){return"data"}constructor(wsurl,endpoint,stream_type){this.url=wsurl,this.stream_type=stream_type,this.endpoint=endpoint,this.data_handler=()=>{},this.error_handler=()=>{},this.disconnect_handler=()=>{},this.builder=new WSPProtocol(WSPProtocol.V1_1),this.awaitingPromises={},this.seq=0,this.encryptor=new JSEncrypt,this.info_handler=()=>{}}set_error_handler(handler){this.error_handler=handler}set_data_handler(handler){this.data_handler=handler}set_disconnect_handler(handler){this.disconnect_handler=handler}set_info_handler(handler){this.info_handler=handler}close(){return Log$a.log("closing connection"),new Promise(resolve=>{this.ctrlChannel.onclose=()=>{this.dataChannel?(this.dataChannel.onclose=()=>{Log$a.log("closed"),resolve()},this.dataChannel.close()):(Log$a.log("closed"),resolve())},this.ctrlChannel.close()})}onDisconnect(error){if(this.ctrlChannel.onclose=null,this.ctrlChannel.close(),this.dataChannel&&(this.dataChannel.onclose=null,this.dataChannel.close()),this.disconnect_handler(error),error.code===WSPProtocol.WCC_INVALID_DOMAIN){let err=new SMediaError(SMediaError.MEDIA_ERR_TRANSPORT);err.message="Invalid Domain (credentials)",Log$a.error("Invalid domain (credentials)"),this.error(err)}}initDataChannel(channel_id){return new Promise((resolve,reject)=>{this.dataChannel=new WebSocket(this.url,WebSocketProxy.CHN_DATA),this.dataChannel.binaryType="arraybuffer",this.dataChannel.onopen=()=>{var msg=this.builder.build(WSPProtocol.CMD_JOIN,{channel:channel_id});Log$a.debug(msg),this.dataChannel.send(msg)},this.dataChannel.onmessage=ev=>{this.dataChannel.onmessage=e=>{this.data_handler&&this.data_handler(e.data)},resolve()},this.dataChannel.onerror=e=>{this.dataChannel.close(),this.error(SMediaError.MEDIA_ERR_TRANSPORT)},this.dataChannel.onclose=e=>{Log$a.error(`[data] ${e.type}. code: ${e.code}, reason: ${e.reason||"unknown reason"}`),this.onDisconnect(e)}})}error(err){return void 0!==err&&(this.error_=new SMediaError(err),this.error_handler&&this.error_handler(this.error_)),this.error_}onProxyCommandResponse(infoObj){LogI.setLevel(4);var expiresAt=infoObj.data.command,requestedDomain=JSON.parse(infoObj.payload);if(expiresAt===WSPProtocol.CMD_GET_INFO&&requestedDomain&&requestedDomain.info){LogI.log("------------- Info ---------------------");infoObj=requestedDomain.info,expiresAt=infoObj.license.expiresAt,requestedDomain=infoObj.requestedDomain;let clients=infoObj.clients;if(LogI.log("License expires at : ",expiresAt),LogI.log("Requested domain   : ",requestedDomain),clients){for(var client in LogI.log("------------- Source list --------------"),clients)LogI.log("Client: ",client),clients[client]?clients[client].forEach(src=>{LogI.log(" ",src.description,":",src.url)}):LogI.log(" Client sources not found");this.info_handler(infoObj)}LogI.log("-----------------------------------------")}}connect(){return this.encryptionKey=null,new Promise((resolve,reject)=>{this.ctrlChannel=new WebSocket(this.url,WebSocketProxy.CHN_CONTROL),this.connected=!1,this.ctrlChannel.onopen=()=>{let headers={proto:this.stream_type};this.endpoint.socket?headers.socket=this.endpoint.socket:Object.assign(headers,{host:this.endpoint.host,port:this.endpoint.port,client:this.endpoint.client});var msg=this.builder.build(WSPProtocol.CMD_INIT,headers);Log$a.debug(msg),this.ctrlChannel.send(msg)},this.ctrlChannel.onmessage=res=>{Log$a.debug(`[ctrl]\r\n${res.data}`);res=WSPProtocol.parse(res.data);if(!res)return reject();if(res.data&&res.data.command&&res.data.type&&res.payload)this.onProxyCommandResponse(res);else{if(300<=res.code)return Log$a.error(`[ctrl]\r\n${res.code}: ${res.msg}`),reject();this.ctrlChannel.onmessage=e=>{var res=WSPProtocol.parse(e.data);Log$a.debug(`[ctrl]\r\n${e.data}`),res.data.seq in this.awaitingPromises&&(res.code<300?this.awaitingPromises[res.data.seq].resolve(res):this.awaitingPromises[res.data.seq].reject(res),delete this.awaitingPromises[res.data.seq])},this.encryptionKey=res.data.pubkey||null,this.encryptionKey&&this.encryptor.setPublicKey(this.encryptionKey),this.initDataChannel(res.data.channel).then(resolve).catch(reject)}},this.ctrlChannel.onerror=e=>{Log$a.error(`[ctrl] ${e.type}`),this.error(SMediaError.MEDIA_ERR_TRANSPORT),this.ctrlChannel.close()},this.ctrlChannel.onclose=e=>{Log$a.error(`[ctrl] ${e.type}. code: ${e.code} ${e.reason||"unknown reason"}`),this.onDisconnect(e)}})}encrypt(msg){if(this.encryptionKey){var crypted=this.encryptor.encrypt(msg);return!1===crypted?void this.error(SMediaError.MEDIA_ERR_ENCRYPTED):crypted}return msg}send(payload){if(this.ctrlChannel.readyState!=WebSocket.OPEN)return this.close(),void this.error(SMediaError.MEDIA_ERR_TRANSPORT);let data={contentLength:payload.length,seq:++WSPProtocol.seq};return{seq:data.seq,promise:new Promise((resolve,msg)=>{this.awaitingPromises[data.seq]={resolve:resolve,reject:msg};msg=this.builder.build(WSPProtocol.CMD_WRAP,data,payload);Log$a.debug(msg),this.ctrlChannel.send(this.encrypt(msg))})}}}const Log$b=getTagged("wsp");class StreamType$1{static get HLS(){return"hls"}static get RTSP(){return"rtsp"}static isSupported(type){return[StreamType$1.HLS,StreamType$1.RTSP].includes(type)}static fromUrl(url){let parsed;try{parsed=Url.parse(url)}catch(e){return null}switch(parsed.protocol){case"rtsp":return StreamType$1.RTSP;case"http":case"https":return 0<=url.indexOf(".m3u8")?StreamType$1.HLS:null;default:return null}}static fromMime(mime){switch(mime){case"application/x-rtsp":return StreamType$1.RTSP;case"application/vnd.apple.mpegurl":case"application/x-mpegurl":return StreamType$1.HLS;default:return null}}}class WSPlayer{constructor(modules,opts){this.player="string"==typeof modules?document.getElementById(modules):modules;var module,modules=opts.modules||{client:RTSPClient,transport:{constructor:WebsocketTransport}};this.errorHandler=opts.errorHandler||null,this.infoHandler=opts.infoHandler||null,this.queryCredentials=opts.queryCredentials||null,this.bufferDuration_=opts.bufferDuration||20,(isNaN(this.bufferDuration_)||this.bufferDuration_<=0)&&(Log$b.warn("Expected number type for bufferDuration"),this.bufferDuration_=20),this.modules={};for(module of modules){let transport=module.transport||WebsocketTransport,client=module.client||RTSPClient;transport.constructor.canTransfer(client.streamType())?this.modules[client.streamType()]={client:client,transport:transport}:Log$b.warn(`Client stream type ${client.streamType()} is incompatible with transport types [${transport.streamTypes().join(", ")}]. Skip`)}if(this.type=StreamType$1.RTSP,this.url=null,opts.url&&opts.type)this.url=opts.url,this.type=opts.type;else if(!this._checkSource(this.player))for(let i=0;i<this.player.children.length&&!this._checkSource(this.player.children[i]);++i);this.url&&this.setSource(this.url,this.type),this.player.addEventListener("play",()=>{this.isPlaying()||this.client.start()},!1),this.player.addEventListener("pause",()=>{this.client.stop()},!1),this.player.addEventListener("seeking",()=>{var bStart,bEnd;this.player.buffered.length&&(bStart=this.player.buffered.start(0),0<(bEnd=this.player.buffered.end(0))-bStart&&(this.player.currentTime<bStart||this.player.currentTime>bEnd)&&(this.player.currentTime<bStart?this.player.currentTime=bStart:this.player.currentTime=bEnd-1))},!1),this.player.addEventListener("abort",()=>{this.client.stop(),this.transport.disconnect().then(()=>{this.client.destroy()})},!1),this.redirectNativeMediaErrors=!opts.hasOwnProperty("redirectNativeMediaErrors")||opts.redirectNativeMediaErrors,this.redirectNativeMediaErrors&&this.player.addEventListener("error",()=>{this.error(this.player.error.code)},!1)}isPlaying(){return!(this.player.paused||this.client.paused)}static canPlayWithModules(mimeType,modules){let filteredModules={};for(var module of modules){let transport=module.transport||WebsocketTransport,client=module.client||RTSPClient;transport.canTransfer(client.streamType())&&(filteredModules[client.streamType()]=!0)}for(var type in filteredModules)if(type==StreamType$1.fromMime(mimeType))return!0;return!1}static canPlay(resource){return StreamType$1.fromMime(resource.type)||StreamType$1.fromUrl(resource.src)}canPlayUrl(src){return StreamType$1.fromUrl(src)in this.modules}_checkSource(src){return!(src.dataset.ignore||!src.src||this.player.canPlayType(src.type)||!StreamType$1.fromMime(src.type)&&!StreamType$1.fromUrl(src.src))&&(this.url=src.src,this.type=src.type?StreamType$1.fromMime(src.type):StreamType$1.fromUrl(src.src),!0)}setSource(lastType,opts){this.transport&&(this.client&&(this.client.detachTransport(),this.client.detachTransport()),this.transport.destroy(),this.transport.destroy());try{this.endpoint=Url.parse(lastType)}catch(e){return void this.error(SMediaError.MEDIA_ERR_SRC_NOT_SUPPORTED)}this.url=lastType;let transport=this.modules[opts].transport;this.transport=new transport.constructor(this.endpoint,this.type,transport.options),this.transport.eventSource.addEventListener("error",errorEvent=>{this.error(errorEvent.detail)}),this.transport.eventSource.addEventListener("info",infoEvent=>{this.info(infoEvent.detail)});lastType=this.type;if(this.type=!!StreamType$1.isSupported(opts)&&opts||StreamType$1.fromMime(opts),this.type){if(lastType==this.type&&this.client)this.client.reset();else{this.client&&(this.client.destroy(),this.client.destroy());let client=this.modules[opts].client;opts={errorHandler:this.errorHandler,flush:200};this.client=new client(opts)}this.queryCredentials&&(this.client.queryCredentials=this.queryCredentials),this.remuxer&&(this.remuxer.destroy(),this.remuxer=null),this.remuxer=new Remuxer(this.player),this.remuxer.MSE.bufferDuration=this.bufferDuration_,this.remuxer.attachClient(this.client),this.client.attachTransport(this.transport),this.client.setSource(this.endpoint),this.player.autoplay&&this.async_connect()}else this.error(SMediaError.MEDIA_ERR_SRC_NOT_SUPPORTED)}async async_connect(){this.start()}async async_setSource(lastType,opts){this.transport&&(this.client&&(await this.client.detachTransport(),this.client.detachTransport()),await this.transport.destroy(),this.transport.destroy());try{this.endpoint=Url.parse(lastType)}catch(e){return void this.error(SMediaError.MEDIA_ERR_SRC_NOT_SUPPORTED)}this.url=lastType;let transport=this.modules[opts].transport;this.transport=new transport.constructor(this.endpoint,this.type,transport.options),this.transport.eventSource.addEventListener("error",errorEvent=>{this.error(errorEvent.detail)}),this.transport.eventSource.addEventListener("info",infoEvent=>{this.info(infoEvent.detail)});lastType=this.type;if(this.type=!!StreamType$1.isSupported(opts)&&opts||StreamType$1.fromMime(opts),this.type){if(lastType==this.type&&this.client)this.client.reset();else{this.client&&(await this.client.destroy(),this.client.destroy());let client=this.modules[opts].client;opts={errorHandler:this.errorHandler,flush:200};this.client=new client(opts)}this.queryCredentials&&(this.client.queryCredentials=this.queryCredentials),this.remuxer&&(this.remuxer.destroy(),this.remuxer=null),this.remuxer=new Remuxer(this.player),this.remuxer.MSE.bufferDuration=this.bufferDuration_,this.remuxer.attachClient(this.client),this.client.attachTransport(this.transport),this.client.setSource(this.endpoint),this.player.autoplay&&this.start()}else this.error(SMediaError.MEDIA_ERR_SRC_NOT_SUPPORTED)}set bufferDuration(duration){this.remuxer&&this.remuxer.MSE&&(this.bufferDuration_=duration,this.remuxer.MSE.bufferDuration=duration)}get bufferDuration(){return this.remuxer?this.remuxer.MSE.bufferDuration:void 0}error(err){return void 0!==err&&(this.error_=new SMediaError(err),this.errorHandler&&(Log$b.error(this.error_.message),this.errorHandler(this.error_))),this.error_}info(inf){void 0!==inf&&this.infoHandler&&this.infoHandler(inf)}start(){this.client&&this.client.start().catch(e=>{this.errorHandler&&this.errorHandler(e)})}stop(){this.client&&this.client.stop()}destroy(){this.transport&&(this.client&&this.client.detachTransport(),this.transport.destroy()),this.client&&this.client.destroy(),this.remuxer&&(this.remuxer.destroy(),this.remuxer=null)}async async_destroy(){this.transport&&(this.client&&await this.client.detachTransport(),await this.transport.destroy()),this.client&&await this.client.destroy(),this.remuxer&&(this.remuxer.destroy(),this.remuxer=null)}}level=LogLevel.Error,DEFAULT_LOG_LEVEL=level,getTagged("transport:ws").setLevel(LogLevel.Error),getTagged("client:rtsp").setLevel(LogLevel.Debug),getTagged("mse").setLevel(LogLevel.Debug),window.Streamedian={logger(tag){return getTagged(tag)},player(node,opts){if(!opts.socket)throw new Error("socket parameter is not set");var _options={modules:[{client:RTSPClient,transport:{constructor:WebsocketTransport,options:{socket:opts.socket}}}],errorHandler(e){opts.errorHandler&&opts.errorHandler(e)},infoHandler(inf){opts.infoHandler&&opts.infoHandler(inf)},redirectNativeMediaErrors:opts.redirectNativeMediaErrors,bufferDuration:opts.bufferDuration,queryCredentials(client){return new Promise((resolve,reject)=>{let c=prompt("input credentials in format user:password");c?(client.setCredentials.apply(client,c.split(":")),resolve()):reject()})}};return new WSPlayer(node,_options)}}}();